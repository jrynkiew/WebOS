"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.sign = sign;
exports.verify = verify;

var _account = require("../account/account");

var _utils = require("../account/utils");

var _crypto = require("../crypto/crypto");

function base64url(str, encoding) {
  return Buffer.from(str, encoding).toString("base64").replace(/=/g, "").replace(/\+/g, "-").replace(/\//g, "_");
}

function toString(obj) {
  if (typeof obj === "string") {
    return obj;
  }

  if (typeof obj === "number" || Buffer.isBuffer(obj)) {
    return obj.toString();
  }

  return JSON.stringify(obj);
} // tslint:disable-next-line:no-any


function isObject(thing) {
  return Object.prototype.toString.call(thing) === "[object Object]";
} // tslint:disable-next-line:no-any


function safeJsonParse(thing) {
  if (isObject(thing)) {
    // @ts-ignore
    return thing;
  }

  try {
    // @ts-ignore
    return JSON.parse(thing);
  } catch (e) {
    return {};
  }
}

function jwsSecuredInput(header, payload, encoding = "utf8") {
  const encodedHeader = base64url(toString(header), "binary");
  const encodedPayload = base64url(toString(payload), encoding);
  return `${encodedHeader}.${encodedPayload}`;
} // tslint:disable-next-line:no-any


function headerFromJWS(jwsSig) {
  const encodedHeader = jwsSig.split(".", 1)[0];
  return safeJsonParse(Buffer.from(encodedHeader, "base64").toString("binary"));
} // tslint:disable-next-line:no-any


function payloadFromJWS(jwsSig) {
  const encodedHeader = jwsSig.split(".")[1];
  return safeJsonParse(Buffer.from(encodedHeader, "base64").toString("binary"));
}

function securedInputFromJWS(jwsSig) {
  return jwsSig.split(".", 2).join(".");
}

function signatureFromJWS(jwsSig) {
  return jwsSig.split(".")[2];
}

const ALG = "EK256K";

async function sign(payload, secretOrPrivateKey) {
  const securedInput = jwsSecuredInput({
    alg: ALG,
    typ: "JWT"
  }, payload);

  const acct = _account.Account.fromPrivateKey(secretOrPrivateKey);

  const sigHex = await acct.sign((0, _utils.fromUtf8)(securedInput));
  const signature = base64url(sigHex.toString("hex"), "hex");
  return `${securedInput}.${signature}`;
}

async function verify(token) {
  const header = headerFromJWS(token);

  if (!header) {
    throw new Error("header is empty or does not have alg");
  }

  if (header.alg !== ALG) {
    throw new Error(`alg should be ${ALG} but got ${header.alg}`);
  }

  const securedInput = securedInputFromJWS(token);
  const signature = signatureFromJWS(token);
  const empty = new _account.Account();
  const recoveredAddress = empty.recover((0, _utils.fromUtf8)(`${securedInput}`), Buffer.from(signature, "base64"), false);
  const securedInputObject = payloadFromJWS(token);
  const secretOrPublicKey = securedInputObject.iss;
  const expectedAddress = (0, _crypto.publicKeyToAddress)(secretOrPublicKey);

  if (recoveredAddress !== expectedAddress) {
    throw new Error(`${recoveredAddress} signed the signature but we are expecting ${expectedAddress}`);
  }

  if (!securedInputObject.iss || securedInputObject.iss !== secretOrPublicKey) {
    throw new Error(`issuer of the token does not match ${secretOrPublicKey}`);
  }

  return securedInputObject;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9qd3Qvand0LnRzIl0sIm5hbWVzIjpbImJhc2U2NHVybCIsInN0ciIsImVuY29kaW5nIiwiQnVmZmVyIiwiZnJvbSIsInRvU3RyaW5nIiwicmVwbGFjZSIsIm9iaiIsImlzQnVmZmVyIiwiSlNPTiIsInN0cmluZ2lmeSIsImlzT2JqZWN0IiwidGhpbmciLCJPYmplY3QiLCJwcm90b3R5cGUiLCJjYWxsIiwic2FmZUpzb25QYXJzZSIsInBhcnNlIiwiZSIsImp3c1NlY3VyZWRJbnB1dCIsImhlYWRlciIsInBheWxvYWQiLCJlbmNvZGVkSGVhZGVyIiwiZW5jb2RlZFBheWxvYWQiLCJoZWFkZXJGcm9tSldTIiwiandzU2lnIiwic3BsaXQiLCJwYXlsb2FkRnJvbUpXUyIsInNlY3VyZWRJbnB1dEZyb21KV1MiLCJqb2luIiwic2lnbmF0dXJlRnJvbUpXUyIsIkFMRyIsInNpZ24iLCJzZWNyZXRPclByaXZhdGVLZXkiLCJzZWN1cmVkSW5wdXQiLCJhbGciLCJ0eXAiLCJhY2N0IiwiQWNjb3VudCIsImZyb21Qcml2YXRlS2V5Iiwic2lnSGV4Iiwic2lnbmF0dXJlIiwidmVyaWZ5IiwidG9rZW4iLCJFcnJvciIsImVtcHR5IiwicmVjb3ZlcmVkQWRkcmVzcyIsInJlY292ZXIiLCJzZWN1cmVkSW5wdXRPYmplY3QiLCJzZWNyZXRPclB1YmxpY0tleSIsImlzcyIsImV4cGVjdGVkQWRkcmVzcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFFQSxTQUFTQSxTQUFULENBQW1CQyxHQUFuQixFQUFnQ0MsUUFBaEMsRUFBa0U7QUFDaEUsU0FBT0MsTUFBTSxDQUFDQyxJQUFQLENBQVlILEdBQVosRUFBaUJDLFFBQWpCLEVBQ0pHLFFBREksQ0FDSyxRQURMLEVBRUpDLE9BRkksQ0FFSSxJQUZKLEVBRVUsRUFGVixFQUdKQSxPQUhJLENBR0ksS0FISixFQUdXLEdBSFgsRUFJSkEsT0FKSSxDQUlJLEtBSkosRUFJVyxHQUpYLENB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Z0IsS0FBS0ssZUFBekIsRUFBMEM7QUFDeEMsVUFBTSxJQUFJUCxLQUFKLENBQ0gsR0FBRUUsZ0JBQWlCLDhDQUE2Q0ssZUFBZ0IsRUFEN0UsQ0FBTjtBQUdEOztBQUNELE1BQUksQ0FBQ0gsa0JBQWtCLENBQUNFLEdBQXBCLElBQTJCRixrQkFBa0IsQ0FBQ0UsR0FBbkIsS0FBMkJELGlCQUExRCxFQUE2RTtBQUMzRSxVQUFNLElBQUlMLEtBQUosQ0FBVyxzQ0FBcUNLLGlCQUFrQixFQUFsRSxDQUFOO0FBQ0Q7O0FBQ0QsU0FBT0Qsa0JBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFjY291bnQgfSBmcm9tIFwiLi4vYWNjb3VudC9hY2NvdW50XCI7XG5pbXBvcnQgeyBmcm9tVXRmOCB9IGZyb20gXCIuLi9hY2NvdW50L3V0aWxzXCI7XG5pbXBvcnQgeyBwdWJsaWNLZXlUb0FkZHJlc3MgfSBmcm9tIFwiLi4vY3J5cHRvL2NyeXB0b1wiO1xuXG5mdW5jdGlvbiBiYXNlNjR1cmwoc3RyOiBzdHJpbmcsIGVuY29kaW5nOiBCdWZmZXJFbmNvZGluZyk6IHN0cmluZyB7XG4gIHJldHVybiBCdWZmZXIuZnJvbShzdHIsIGVuY29kaW5nKVxuICAgIC50b1N0cmluZyhcImJhc2U2NFwiKVxuICAgIC5yZXBsYWNlKC89L2csIFwiXCIpXG4gICAgLnJlcGxhY2UoL1xcKy9nLCBcIi1cIilcbiAgICAucmVwbGFjZSgvXFwvL2csIFwiX1wiKTtcbn1cblxuZnVuY3Rpb24gdG9TdHJpbmcob2JqOiBvYmplY3QpOiBzdHJpbmcge1xuICBpZiAodHlwZW9mIG9iaiA9PT0gXCJzdHJpbmdcIikge1xuICAgIHJldHVybiBvYmo7XG4gIH1cbiAgaWYgKHR5cGVvZiBvYmogPT09IFwibnVtYmVyXCIgfHwgQnVmZmVyLmlzQnVmZmVyKG9iaikpIHtcbiAgICByZXR1cm4gb2JqLnRvU3RyaW5nKCk7XG4gIH1cbiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaik7XG59XG5cbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnlcbmZ1bmN0aW9uIGlzT2JqZWN0KHRoaW5nOiBhbnkpOiBib29sZWFuIHtcbiAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh0aGluZykgPT09IFwiW29iamVjdCBPYmplY3RdXCI7XG59XG5cbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnlcbmZ1bmN0aW9uIHNhZmVKc29uUGFyc2UodGhpbmc6IHN0cmluZyB8IG9iamVjdCk6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICBpZiAoaXNPYmplY3QodGhpbmcpKSB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHJldHVybiB0aGluZztcbiAgfVxuICB0cnkge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICByZXR1cm4gSlNPTi5wYXJzZSh0aGluZyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4ge307XG4gIH1cbn1cblxuZnVuY3Rpb24gandzU2VjdXJlZElucHV0KFxuICBoZWFkZXI6IG9iamVjdCxcbiAgcGF5bG9hZDogb2JqZWN0LFxuICBlbmNvZGluZzogQnVmZmVyRW5jb2RpbmcgPSBcInV0ZjhcIlxuKTogc3RyaW5nIHtcbiAgY29uc3QgZW5jb2RlZEhlYWRlciA9IGJhc2U2NHVybCh0b1N0cmluZyhoZWFkZXIpLCBcImJpbmFyeVwiKTtcbiAgY29uc3QgZW5jb2RlZFBheWxvYWQgPSBiYXNlNjR1cmwodG9TdHJpbmcocGF5bG9hZCksIGVuY29kaW5nKTtcbiAgcmV0dXJuIGAke2VuY29kZWRIZWFkZXJ9LiR7ZW5jb2RlZFBheWxvYWR9YDtcbn1cblxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxuZnVuY3Rpb24gaGVhZGVyRnJvbUpXUyhqd3NTaWc6IHN0cmluZyk6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICBjb25zdCBlbmNvZGVkSGVhZGVyID0gandzU2lnLnNwbGl0KFwiLlwiLCAxKVswXTtcbiAgcmV0dXJuIHNhZmVKc29uUGFyc2UoQnVmZmVyLmZyb20oZW5jb2RlZEhlYWRlciwgXCJiYXNlNjRcIikudG9TdHJpbmcoXCJiaW5hcnlcIikpO1xufVxuXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XG5mdW5jdGlvbiBwYXlsb2FkRnJvbUpXUyhqd3NTaWc6IHN0cmluZyk6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICBjb25zdCBlbmNvZGVkSGVhZGVyID0gandzU2lnLnNwbGl0KFwiLlwiKVsxXTtcbiAgcmV0dXJuIHNhZmVKc29uUGFyc2UoQnVmZmVyLmZyb20oZW5jb2RlZEhlYWRlciwgXCJiYXNlNjRcIikudG9TdHJpbmcoXCJiaW5hcnlcIikpO1xufVxuXG5mdW5jdGlvbiBzZWN1cmVkSW5wdXRGcm9tSldTKGp3c1NpZzogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIGp3c1NpZy5zcGxpdChcIi5cIiwgMikuam9pbihcIi5cIik7XG59XG5cbmZ1bmN0aW9uIHNpZ25hdHVyZUZyb21KV1MoandzU2lnOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gandzU2lnLnNwbGl0KFwiLlwiKVsyXTtcbn1cblxuY29uc3QgQUxHID0gXCJFSzI1NktcIjtcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzaWduKFxuICBwYXlsb2FkOiBvYmplY3QsXG4gIHNlY3JldE9yUHJpdmF0ZUtleTogc3RyaW5nXG4pOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCBzZWN1cmVkSW5wdXQgPSBqd3NTZWN1cmVkSW5wdXQoXG4gICAge1xuICAgICAgYWxnOiBBTEcsXG4gICAgICB0eXA6IFwiSldUXCJcbiAgICB9LFxuICAgIHBheWxvYWRcbiAgKTtcbiAgY29uc3QgYWNjdCA9IEFjY291bnQuZnJvbVByaXZhdGVLZXkoc2VjcmV0T3JQcml2YXRlS2V5KTtcbiAgY29uc3Qgc2lnSGV4ID0gYXdhaXQgYWNjdC5zaWduKGZyb21VdGY4KHNlY3VyZWRJbnB1dCkpO1xuICBjb25zdCBzaWduYXR1cmUgPSBiYXNlNjR1cmwoc2lnSGV4LnRvU3RyaW5nKFwiaGV4XCIpLCBcImhleFwiKTtcbiAgcmV0dXJuIGAke3NlY3VyZWRJbnB1dH0uJHtzaWduYXR1cmV9YDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHZlcmlmeShcbiAgdG9rZW46IHN0cmluZ1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XG4pOiBQcm9taXNlPFJlY29yZDxzdHJpbmcsIGFueT4+IHtcbiAgY29uc3QgaGVhZGVyID0gaGVhZGVyRnJvbUpXUyh0b2tlbik7XG4gIGlmICghaGVhZGVyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiaGVhZGVyIGlzIGVtcHR5IG9yIGRvZXMgbm90IGhhdmUgYWxnXCIpO1xuICB9XG4gIGlmIChoZWFkZXIuYWxnICE9PSBBTEcpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYGFsZyBzaG91bGQgYmUgJHtBTEd9IGJ1dCBnb3QgJHtoZWFkZXIuYWxnfWApO1xuICB9XG4gIGNvbnN0IHNlY3VyZWRJbnB1dCA9IHNlY3VyZWRJbnB1dEZyb21KV1ModG9rZW4pO1xuICBjb25zdCBzaWduYXR1cmUgPSBzaWduYXR1cmVGcm9tSldTKHRva2VuKTtcbiAgY29uc3QgZW1wdHkgPSBuZXcgQWNjb3VudCgpO1xuICBjb25zdCByZWNvdmVyZWRBZGRyZXNzID0gZW1wdHkucmVjb3ZlcihcbiAgICBmcm9tVXRmOChgJHtzZWN1cmVkSW5wdXR9YCksXG4gICAgQnVmZmVyLmZyb20oc2lnbmF0dXJlLCBcImJhc2U2NFwiKSxcbiAgICBmYWxzZVxuICApO1xuICBjb25zdCBzZWN1cmVkSW5wdXRPYmplY3QgPSBwYXlsb2FkRnJvbUpXUyh0b2tlbik7XG4gIGNvbnN0IHNlY3JldE9yUHVibGljS2V5ID0gc2VjdXJlZElucHV0T2JqZWN0LmlzcztcbiAgY29uc3QgZXhwZWN0ZWRBZGRyZXNzID0gcHVibGljS2V5VG9BZGRyZXNzKHNlY3JldE9yUHVibGljS2V5KTtcbiAgaWYgKHJlY292ZXJlZEFkZHJlc3MgIT09IGV4cGVjdGVkQWRkcmVzcykge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGAke3JlY292ZXJlZEFkZHJlc3N9IHNpZ25lZCB0aGUgc2lnbmF0dXJlIGJ1dCB3ZSBhcmUgZXhwZWN0aW5nICR7ZXhwZWN0ZWRBZGRyZXNzfWBcbiAgICApO1xuICB9XG4gIGlmICghc2VjdXJlZElucHV0T2JqZWN0LmlzcyB8fCBzZWN1cmVkSW5wdXRPYmplY3QuaXNzICE9PSBzZWNyZXRPclB1YmxpY0tleSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgaXNzdWVyIG9mIHRoZSB0b2tlbiBkb2VzIG5vdCBtYXRjaCAke3NlY3JldE9yUHVibGljS2V5fWApO1xuICB9XG4gIHJldHVybiBzZWN1cmVkSW5wdXRPYmplY3Q7XG59XG4iXX0=