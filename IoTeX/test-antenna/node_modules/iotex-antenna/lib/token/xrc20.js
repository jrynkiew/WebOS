"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.XRC20 = void 0;

var _bignumber = _interopRequireDefault(require("bignumber.js"));

var _web3EthAbi = _interopRequireDefault(require("web3-eth-abi"));

var _abiToByte = require("../contract/abi-to-byte");

var _contract = require("../contract/contract");

var _address = require("../crypto/address");

var _abi = require("./abi");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const Abi = _web3EthAbi.default;

class XRC20 {
  constructor(address, options) {
    _defineProperty(this, "address", void 0);

    _defineProperty(this, "contract", void 0);

    _defineProperty(this, "methods", void 0);

    _defineProperty(this, "tokenName", void 0);

    _defineProperty(this, "tokenSymbol", void 0);

    _defineProperty(this, "tokenDecimals", void 0);

    _defineProperty(this, "tokenTotalSupply", void 0);

    this.address = address;
    this.contract = new _contract.Contract(_abi.XRC20_ABI, address, options);
    const methods = {}; // @ts-ignore

    for (const fnName of Object.keys(this.contract.getABI())) {
      // @ts-ignore
      const fnAbi = this.contract.getABI()[fnName];

      if (fnAbi.type === "constructor") {
        continue;
      }

      const args = (0, _abiToByte.getArgTypes)(fnAbi);
      const header = (0, _abiToByte.getHeaderHash)(fnAbi, args); // @ts-ignore

      methods[header] = {
        name: fnName,
        inputsNames: args.map(i => {
          return `${i.name}`;
        }),
        inputsTypes: args.map(i => {
          return `${i.type}`;
        })
      };
    }

    this.methods = methods;
  }

  async name() {
    if (this.tokenName) {
      return this.tokenName;
    }

    const result = await this.readMethod("name", this.address);
    const data = Abi.decodeParameter("string", result);

    if (data.length > 0) {
      this.tokenName = data[0];
      return this.tokenName;
    }

    return "";
  }

  async symbol() {
    if (this.tokenSymbol) {
      return this.tokenSymbol;
    }

    const result = await this.readMethod("symbol", this.address);
    const data = Abi.decodeParameter("string", result);

    if (data.length > 0) {
      this.tokenSymbol = data[0];
      return this.tokenSymbol;
    }

    return "";
  }

  async decimals() {
    if (this.tokenDecimals) {
      return this.tokenDecimals;
    }

    const result = await this.readMethod("decimals", this.address);
    this.tokenDecimals = new _bignumber.default(result, 16);
    return this.tokenDecimals;
  }

  async totalSupply() {
    if (this.tokenTotalSupply) {
      return this.tokenTotalSupply;
    }

    const result = await this.readMethod("totalSupply", this.address);
    this.tokenTotalSupply = new _bignumber.default(result, 16);
    return this.tokenTotalSupply;
  }

  async balanceOf(owner) {
    const result = await this.readMethod("balanceOf", this.address, owner);
    return new _bignumber.default(result, 16);
  }

  async transfer(to, value, options) {
    return this.executeMethod("transfer", options.account, options.gasPrice, options.gasLimit, "0", to, value.toFixed(0));
  }

  async allowance(owner, spender, options) {
    return this.executeMethod("allowance", options.account, options.gasPrice, options.gasLimit, "0", owner, spender);
  }

  async approve(spender, value, options) {
    return this.executeMethod("approve", options.account, options.gasPrice, options.gasLimit, "0", spender, value.toFixed(0));
  }

  async transferFrom(from, to, value, options) {
    return this.executeMethod("transferFrom", options.account, options.gasPrice, options.gasLimit, "0", from, to, value.toFixed(0));
  }

  async readMethod(method, callerAddress, // @ts-ignore
  // tslint:disable-next-line: typedef
  ...args) {
    if (!this.contract.provider) {
      throw new Error("no rpc method provider specified");
    }

    const result = await this.contract.provider.readContract({
      execution: this.contract.pureEncodeMethod("0", method, ...args),
      callerAddress: callerAddress
    });
    return result.data;
  }

  executeMethod(method, account, gasPrice, gasLimit, amount, // @ts-ignore
  // tslint:disable-next-line: typedef
  ...args) {
    return this.contract.methods[method](...args, {
      account: account,
      amount: amount,
      gasLimit: gasLimit,
      gasPrice: gasPrice
    });
  }

  decode(data) {
    if (data.length < 8) {
      throw new Error("input data error");
    }

    const methodKey = data.substr(0, 8);
    const method = this.methods[methodKey];

    if (!method) {
      throw new Error(`method ${methodKey} is not erc20 method`);
    }

    const params = Abi.decodeParameters(method.inputsTypes, data.substring(8));
    const values = {};

    for (let i = 0; i < method.inputsTypes.length; i++) {
      if (method.inputsTypes[i] === "address") {
        params[i] = (0, _address.fromBytes)(Buffer.from(params[i].substring(2), "hex")).string();
      } // @ts-ignore


      values[method.inputsNames[i]] = params[i];
    }

    return {
      method: method.name,
      data: values
    };
  }

}

exports.XRC20 = XRC20;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90b2tlbi94cmMyMC50cyJdLCJuYW1lcyI6WyJBYmkiLCJXZWIzQWJpIiwiWFJDMjAiLCJjb25zdHJ1Y3RvciIsImFkZHJlc3MiLCJvcHRpb25zIiwiY29udHJhY3QiLCJDb250cmFjdCIsIlhSQzIwX0FCSSIsIm1ldGhvZHMiLCJmbk5hbWUiLCJPYmplY3QiLCJrZXlzIiwiZ2V0QUJJIiwiZm5BYmkiLCJ0eXBlIiwiYXJncyIsImhlYWRlciIsIm5hbWUiLCJpbnB1dHNOYW1lcyIsIm1hcCIsImkiLCJpbnB1dHNUeXBlcyIsInRva2VuTmFtZSIsInJlc3VsdCIsInJlYWRNZXRob2QiLCJkYXRhIiwiZGVjb2RlUGFyYW1ldGVyIiwibGVuZ3RoIiwic3ltYm9sIiwidG9rZW5TeW1ib2wiLCJkZWNpbWFscyIsInRva2VuRGVjaW1hbHMiLCJCaWdOdW1iZXIiLCJ0b3RhbFN1cHBseSIsInRva2VuVG90YWxTdXBwbHkiLCJiYWxhbmNlT2YiLCJvd25lciIsInRyYW5zZmVyIiwidG8iLCJ2YWx1ZSIsImV4ZWN1dGVNZXRob2QiLCJhY2NvdW50IiwiZ2FzUHJpY2UiLCJnYXNMaW1pdCIsInRvRml4ZWQiLCJhbGxvd2FuY2UiLCJzcGVuZGVyIiwiYXBwcm92ZSIsInRyYW5zZmVyRnJvbSIsImZyb20iLCJtZXRob2QiLCJjYWxsZXJBZGRyZXNzIiwicHJvdmlkZXIiLCJFcnJvciIsInJlYWRDb250cmFjdCIsImV4ZWN1dGlvbiIsInB1cmVFbmNvZGVNZXRob2QiLCJhbW91bnQiLCJkZWNvZGUiLCJtZXRob2RLZXkiLCJzdWJzdHIiLCJwYXJhbXMiLCJkZWNvZGVQYXJhbWV0ZXJzIiwic3Vic3RyaW5nIiwidmFsdWVzIiwiQnVmZmVyIiwic3RyaW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVBLE1BQU1BLEdBQUcsR0FBSUMsbUJBQWI7O0FBb0JPLE1BQU1DLEtBQU4sQ0FBWTtBQVNqQkMsRUFBQUEsV0FBVyxDQUFDQyxPQUFELEVBQWtCQyxPQUFsQixFQUFxQztBQUFBOztBQUFBOztBQUFBOztBQUFBOztBQUFBOztBQUFBOztBQUFBOztBQUM5QyxTQUFLRCxPQUFMLEdBQWVBLE9BQWY7QUFDQSxTQUFLRSxRQUFMLEdBQWdCLElBQUlDLGtCQUFKLENBQWFDLGNBQWIsRUFBd0JKLE9BQXhCLEVBQWlDQyxPQUFqQyxDQUFoQjtBQUVBLFVBQU1JLE9BQU8sR0FBRyxFQUFoQixDQUo4QyxDQUs5Qzs7QUFDQSxTQUFLLE1BQU1DLE1BQVgsSUFBcUJDLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZLEtBQUtOLFFBQUwsQ0FBY08sTUFBZCxFQUFaLENBQXJCLEVBQTBEO0FBQ3hEO0FBQ0EsWUFBTUMsS0FBSyxHQUFHLEtBQUtSLFFBQUwsQ0FBY08sTUFBZCxHQUF1QkgsTUFBdkIsQ0FBZDs7QUFDQSxVQUFJSSxLQUFLLENBQUNDLElBQU4sS0FBZSxhQUFuQixFQUFrQztBQUNoQztBQUNEOztBQUVELFlBQU1DLElBQUksR0FBRyw0QkFBWUYsS0FBWixDQUFiO0FBQ0EsWUFBTUcsTUFBTSxHQUFHLDhCQUFjSCxLQUFkLEVBQXFCRSxJQUFyQixDQUFmLENBUndELENBVXhEOztBQUNBUCxNQUFBQSxPQUFPLENBQUNRLE1BQUQsQ0FBUCxHQUFrQjtBQUNoQkMsUUFBQUEsSUFBSSxFQUFFUixNQURVO0FBRWhCUyxRQUFBQSxXQUFXLEVBQUVILElBQUksQ0FBQ0ksR0FBTCxDQUFTQyxDQUFDLElBQUk7QUFDekIsaUJBQVEsR0FBRUEsQ0FBQyxDQUFDSCxJQUFLLEVBQWpCO0FBQ0QsU0FGWSxDQUZHO0FBS2hCSSxRQUFBQSxXQUFXLEVBQUVOLElBQUksQ0FBQ0ksR0FBTCxDQUFTQyxDQUFDLElBQUk7QUFDekIsaUJBQVEsR0FBRUEsQ0FBQyxDQUFDTixJQUFLLEVBQWpCO0FBQ0QsU0FGWTtBQUxHLE9BQWxCO0FBU0Q7O0FBQ0QsU0FBS04sT0FBTCxHQUFlQSxPQUFmO0FBQ0Q7O0FBRWdCLFFBQUpTLElBQUksR0FBb0I7QUFDbkMsUUFBSSxLQUFLSyxTQUFULEVBQW9CO0FBQ2xCLGFBQU8sS0FBS0EsU0FBWjtBQUNEOztBQUNELFVBQU1DLE1BQU0sR0FBRyxNQUFNLEtBQUtDLFVBQUwsQ0FBZ0IsTUFBaEIsRUFBd0IsS0FBS3JCLE9BQTdCLENBQXJCO0FBQ0EsVUFBTXNCLElBQUksR0FBRzFCLEdBQUcsQ0FBQzJCLGVBQUosQ0FBb0IsUUFBcEIsRUFBOEJILE1BQTlCLENBQWI7O0FBQ0EsUUFBSUUsSUFBSSxDQUFDRSxNQUFMLEdBQWMsQ0FBbEIsRUFBcUI7QUFDbkIsV0FBS0wsU0FBTCxHQUFpQkcsSUFBSSxDQUFDLENBQUQsQ0FBckI7QUFDQSxhQUFPLEtBQUtILFNBQVo7QUFDRDs7QUFDRCxXQUFPLEVBQVA7QUFDRDs7QUFFa0IsUUFBTk0sTUFBTSxHQUFvQjtBQUNyQyxRQUFJLEtBQUtDLFdBQVQsRUFBc0I7QUFDcEIsYUFBTyxLQUFLQSxXQUFaO0FBQ0Q7O0FBQ0QsVUFBTU4sTUFBTSxHQUFHLE1BQU0sS0FBS0MsVUFBTCxDQUFnQixRQUFoQixFQUEwQixLQUFLckIsT0FBL0IsQ0FBckI7QUFDQSxVQUFNc0IsSUFBSSxHQUFHMUIsR0FBRyxDQUFDMkIsZUFBSixDQUFvQixRQUFwQixFQUE4QkgsTUFBOUIsQ0FBYjs7QUFDQSxRQUFJRSxJQUFJLENBQUNFLE1BQUwsR0FBYyxDQUFsQixFQUFxQjtBQUNuQixXQUFLRSxXQUFMLEdBQW1CSixJQUFJLENBQUMsQ0FBRCxDQUF2QjtBQUNBLGFBQU8sS0FBS0ksV0FBWjtBQUNEOztBQUNELFdBQU8sRUFBUDtBQUNEOztBQUVvQixRQUFSQyxRQUFRLEdBQXVCO0FBQzFDLFFBQUksS0FBS0MsYUFBVCxFQUF3QjtBQUN0QixhQUFPLEtBQUtBLGFBQVo7QUFDRDs7QUFDRCxVQUFNUixNQUFNLEdBQUcsTUFBTSxLQUFLQyxVQUFMLENBQWdCLFVBQWhCLEVBQTRCLEtBQUtyQixPQUFqQyxDQUFyQjtBQUNBLFNBQUs0QixhQUFMLEdBQXFCLElBQUlDLGtCQUFKLENBQWNULE1BQWQsRUFBc0IsRUFBdEIsQ0FBckI7QUFDQSxXQUFPLEtBQUtRLGFBQVo7QUFDRDs7QUFFdUIsUUFBWEUsV0FBVyxHQUF1QjtBQUM3QyxRQUFJLEtBQUtDLGdCQUFULEVBQTJCO0FBQ3pCLGFBQU8sS0FBS0EsZ0JBQVo7QUFDRDs7QUFDRCxVQUFNWCxNQUFNLEdBQUcsTUFBTSxLQUFLQyxVQUFMLENBQWdCLGFBQWhCLEVBQStCLEtBQUtyQixPQUFwQyxDQUFyQjtBQUNBLFNBQUsrQixnQkFBTCxHQUF3QixJQUFJRixrQkFBSixDQUFjVCxNQUFkLEVBQXNCLEVBQXRCLENBQXhCO0FBQ0EsV0FBTyxLQUFLVyxnQkFBWjtBQUNEOztBQUVxQixRQUFUQyxTQUFTLENBQUNDLEtBQUQsRUFBb0M7QUFDeEQsVUFBTWIsTUFBTSxHQUFHLE1BQU0sS0FBS0MsVUFBTCxDQUFnQixXQUFoQixFQUE2QixLQUFLckIsT0FBbEMsRUFBMkNpQyxLQUEzQyxDQUFyQjtBQUNBLFdBQU8sSUFBSUosa0JBQUosQ0FBY1QsTUFBZCxFQUFzQixFQUF0QixDQUFQO0FBQ0Q7O0FBRW9CLFFBQVJjLFFBQVEsQ0FDbkJDLEVBRG1CLEVBRW5CQyxLQUZtQixFQUduQm5DLE9BSG1CLEVBSUY7QUFDakIsV0FBTyxLQUFLb0MsYUFBTCxDQUNMLFVBREssRUFFTHBDLE9BQU8sQ0FBQ3FDLE9BRkgsRUFHTHJDLE9BQU8sQ0FBQ3NDLFFBSEgsRUFJTHRDLE9BQU8sQ0FBQ3VDLFFBSkgsRUFLTCxHQUxLLEVBTUxMLEVBTkssRUFPTEMsS0FBSyxDQUFDSyxPQUFOLENBQWMsQ0FBZCxDQVBLLENBQVA7QUFTRDs7QUFFcUIsUUFBVEMsU0FBUyxDQUNwQlQsS0FEb0IsRUFFcEJVLE9BRm9CLEVBR3BCMUMsT0FIb0IsRUFJSDtBQUNqQixXQUFPLEtBQUtvQyxhQUFMLENBQ0wsV0FESyxFQUVMcEMsT0FBTyxDQUFDcUMsT0FGSCxFQUdMckMsT0FBTyxDQUFDc0MsUUFISCxFQUlMdEMsT0FBTyxDQUFDdUMsUUFKSCxFQUtMLEdBTEssRUFNTFAsS0FOSyxFQU9MVSxPQVBLLENBQVA7QUFTRDs7QUFFbUIsUUFBUEMsT0FBTyxDQUNsQkQsT0FEa0IsRUFFbEJQLEtBRmtCLEVBR2xCbkMsT0FIa0IsRUFJRDtBQUNqQixXQUFPLEtBQUtvQyxhQUFMLENBQ0wsU0FESyxFQUVMcEMsT0FBTyxDQUFDcUMsT0FGSCxFQUdMckMsT0FBTyxDQUFDc0MsUUFISCxFQUlMdEMsT0FBTyxDQUFDdUMsUUFKSCxFQUtMLEdBTEssRUFNTEcsT0FOSyxFQU9MUCxLQUFLLENBQUNLLE9BQU4sQ0FBYyxDQUFkLENBUEssQ0FBUDtBQVNEOztBQUV3QixRQUFaSSxZQUFZLENBQ3ZCQyxJQUR1QixFQUV2QlgsRUFGdUIsRUFHdkJDLEtBSHVCLEVBSXZCbkMsT0FKdUIsRUFLTjtBQUNqQixXQUFPLEtBQUtvQyxhQUFMLENBQ0wsY0FESyxFQUVMcEMsT0FBTyxDQUFDcUMsT0FGSCxFQUdMckMsT0FBTyxDQUFDc0MsUUFISCxFQUlMdEMsT0FBTyxDQUFDdUMsUUFKSCxFQUtMLEdBTEssRUFNTE0sSUFOSyxFQU9MWCxFQVBLLEVBUUxDLEtBQUssQ0FBQ0ssT0FBTixDQUFjLENBQWQsQ0FSSyxDQUFQO0FBVUQ7O0FBRXVCLFFBQVZwQixVQUFVLENBQ3RCMEIsTUFEc0IsRUFFdEJDLGFBRnNCLEVBR3RCO0FBQ0E7QUFDQSxLQUFHcEMsSUFMbUIsRUFNTDtBQUNqQixRQUFJLENBQUMsS0FBS1YsUUFBTCxDQUFjK0MsUUFBbkIsRUFBNkI7QUFDM0IsWUFBTSxJQUFJQyxLQUFKLENBQVUsa0NBQVYsQ0FBTjtBQUNEOztBQUVELFVBQU05QixNQUFNLEdBQUcsTUFBTSxLQUFLbEIsUUFBTCxDQUFjK0MsUUFBZCxDQUF1QkUsWUFBdkIsQ0FBb0M7QUFDdkRDLE1BQUFBLFNBQVMsRUFBRSxLQUFLbEQsUUFBTCxDQUFjbUQsZ0JBQWQsQ0FBK0IsR0FBL0IsRUFBb0NOLE1BQXBDLEVBQTRDLEdBQUduQyxJQUEvQyxDQUQ0QztBQUV2RG9DLE1BQUFBLGFBQWEsRUFBRUE7QUFGd0MsS0FBcEMsQ0FBckI7QUFLQSxXQUFPNUIsTUFBTSxDQUFDRSxJQUFkO0FBQ0Q7O0FBRU9lLEVBQUFBLGFBQWEsQ0FDbkJVLE1BRG1CLEVBRW5CVCxPQUZtQixFQUduQkMsUUFIbUIsRUFJbkJDLFFBSm1CLEVBS25CYyxNQUxtQixFQU1uQjtBQUNBO0FBQ0EsS0FBRzFDLElBUmdCLEVBU1g7QUFDUixXQUFPLEtBQUtWLFFBQUwsQ0FBY0csT0FBZCxDQUFzQjBDLE1BQXRCLEVBQThCLEdBQUduQyxJQUFqQyxFQUF1QztBQUM1QzBCLE1BQUFBLE9BQU8sRUFBRUEsT0FEbUM7QUFFNUNnQixNQUFBQSxNQUFNLEVBQUVBLE1BRm9DO0FBRzVDZCxNQUFBQSxRQUFRLEVBQUVBLFFBSGtDO0FBSTVDRCxNQUFBQSxRQUFRLEVBQUVBO0FBSmtDLEtBQXZDLENBQVA7QUFNRDs7QUFFTWdCLEVBQUFBLE1BQU0sQ0FBQ2pDLElBQUQsRUFBMkI7QUFDdEMsUUFBSUEsSUFBSSxDQUFDRSxNQUFMLEdBQWMsQ0FBbEIsRUFBcUI7QUFDbkIsWUFBTSxJQUFJMEIsS0FBSixDQUFVLGtCQUFWLENBQU47QUFDRDs7QUFDRCxVQUFNTSxTQUFTLEdBQUdsQyxJQUFJLENBQUNtQyxNQUFMLENBQVksQ0FBWixFQUFlLENBQWYsQ0FBbEI7QUFDQSxVQUFNVixNQUFNLEdBQUcsS0FBSzFDLE9BQUwsQ0FBYW1ELFNBQWIsQ0FBZjs7QUFDQSxRQUFJLENBQUNULE1BQUwsRUFBYTtBQUNYLFlBQU0sSUFBSUcsS0FBSixDQUFXLFVBQVNNLFNBQVUsc0JBQTlCLENBQU47QUFDRDs7QUFDRCxVQUFNRSxNQUFNLEdBQUc5RCxHQUFHLENBQUMrRCxnQkFBSixDQUFxQlosTUFBTSxDQUFDN0IsV0FBNUIsRUFBeUNJLElBQUksQ0FBQ3NDLFNBQUwsQ0FBZSxDQUFmLENBQXpDLENBQWY7QUFDQSxVQUFNQyxNQUFNLEdBQUcsRUFBZjs7QUFFQSxTQUFLLElBQUk1QyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHOEIsTUFBTSxDQUFDN0IsV0FBUCxDQUFtQk0sTUFBdkMsRUFBK0NQLENBQUMsRUFBaEQsRUFBb0Q7QUFDbEQsVUFBSThCLE1BQU0sQ0FBQzdCLFdBQVAsQ0FBbUJELENBQW5CLE1BQTBCLFNBQTlCLEVBQXlDO0FBQ3ZDeUMsUUFBQUEsTUFBTSxDQUFDekMsQ0FBRCxDQUFOLEdBQVksd0JBQ1Y2QyxNQUFNLENBQUNoQixJQUFQLENBQVlZLE1BQU0sQ0FBQ3pDLENBQUQsQ0FBTixDQUFVMkMsU0FBVixDQUFvQixDQUFwQixDQUFaLEVBQW9DLEtBQXBDLENBRFUsRUFFVkcsTUFGVSxFQUFaO0FBR0QsT0FMaUQsQ0FNbEQ7OztBQUNBRixNQUFBQSxNQUFNLENBQUNkLE1BQU0sQ0FBQ2hDLFdBQVAsQ0FBbUJFLENBQW5CLENBQUQsQ0FBTixHQUFnQ3lDLE1BQU0sQ0FBQ3pDLENBQUQsQ0FBdEM7QUFDRDs7QUFFRCxXQUFPO0FBQ0w4QixNQUFBQSxNQUFNLEVBQUVBLE1BQU0sQ0FBQ2pDLElBRFY7QUFFTFEsTUFBQUEsSUFBSSxFQUFFdUM7QUFGRCxLQUFQO0FBSUQ7O0FBek5nQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBCaWdOdW1iZXIgZnJvbSBcImJpZ251bWJlci5qc1wiO1xuaW1wb3J0IFdlYjNBYmksIHsgQWJpQ29kZXIgfSBmcm9tIFwid2ViMy1ldGgtYWJpXCI7XG5pbXBvcnQgeyBBY2NvdW50IH0gZnJvbSBcIi4uL2FjY291bnQvYWNjb3VudFwiO1xuaW1wb3J0IHsgZ2V0QXJnVHlwZXMsIGdldEhlYWRlckhhc2ggfSBmcm9tIFwiLi4vY29udHJhY3QvYWJpLXRvLWJ5dGVcIjtcbmltcG9ydCB7IENvbnRyYWN0LCBPcHRpb25zIH0gZnJvbSBcIi4uL2NvbnRyYWN0L2NvbnRyYWN0XCI7XG5pbXBvcnQgeyBmcm9tQnl0ZXMgfSBmcm9tIFwiLi4vY3J5cHRvL2FkZHJlc3NcIjtcbmltcG9ydCB7IFhSQzIwX0FCSSB9IGZyb20gXCIuL2FiaVwiO1xuXG5jb25zdCBBYmkgPSAoV2ViM0FiaSBhcyB1bmtub3duKSBhcyBBYmlDb2RlcjtcblxuZXhwb3J0IGludGVyZmFjZSBNZXRob2Qge1xuICBuYW1lOiBzdHJpbmc7XG4gIGlucHV0c05hbWVzOiBbc3RyaW5nXTtcbiAgaW5wdXRzVHlwZXM6IFtzdHJpbmddO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERlY29kZURhdGEge1xuICBtZXRob2Q6IHN0cmluZztcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1hbnlcbiAgZGF0YTogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFeGVjdXRlT3B0aW9uIHtcbiAgYWNjb3VudDogQWNjb3VudDtcbiAgZ2FzUHJpY2U6IHN0cmluZztcbiAgZ2FzTGltaXQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIFhSQzIwIHtcbiAgcHVibGljIGFkZHJlc3M6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBjb250cmFjdDogQ29udHJhY3Q7XG4gIHByaXZhdGUgcmVhZG9ubHkgbWV0aG9kczogeyBba2V5OiBzdHJpbmddOiBNZXRob2QgfTtcbiAgcHJpdmF0ZSB0b2tlbk5hbWU6IHN0cmluZztcbiAgcHJpdmF0ZSB0b2tlblN5bWJvbDogc3RyaW5nO1xuICBwcml2YXRlIHRva2VuRGVjaW1hbHM6IEJpZ051bWJlcjtcbiAgcHJpdmF0ZSB0b2tlblRvdGFsU3VwcGx5OiBCaWdOdW1iZXI7XG5cbiAgY29uc3RydWN0b3IoYWRkcmVzczogc3RyaW5nLCBvcHRpb25zPzogT3B0aW9ucykge1xuICAgIHRoaXMuYWRkcmVzcyA9IGFkZHJlc3M7XG4gICAgdGhpcy5jb250cmFjdCA9IG5ldyBDb250cmFjdChYUkMyMF9BQkksIGFkZHJlc3MsIG9wdGlvbnMpO1xuXG4gICAgY29uc3QgbWV0aG9kcyA9IHt9O1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBmb3IgKGNvbnN0IGZuTmFtZSBvZiBPYmplY3Qua2V5cyh0aGlzLmNvbnRyYWN0LmdldEFCSSgpKSkge1xuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgY29uc3QgZm5BYmkgPSB0aGlzLmNvbnRyYWN0LmdldEFCSSgpW2ZuTmFtZV07XG4gICAgICBpZiAoZm5BYmkudHlwZSA9PT0gXCJjb25zdHJ1Y3RvclwiKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBhcmdzID0gZ2V0QXJnVHlwZXMoZm5BYmkpO1xuICAgICAgY29uc3QgaGVhZGVyID0gZ2V0SGVhZGVySGFzaChmbkFiaSwgYXJncyk7XG5cbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIG1ldGhvZHNbaGVhZGVyXSA9IHtcbiAgICAgICAgbmFtZTogZm5OYW1lLFxuICAgICAgICBpbnB1dHNOYW1lczogYXJncy5tYXAoaSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGAke2kubmFtZX1gO1xuICAgICAgICB9KSxcbiAgICAgICAgaW5wdXRzVHlwZXM6IGFyZ3MubWFwKGkgPT4ge1xuICAgICAgICAgIHJldHVybiBgJHtpLnR5cGV9YDtcbiAgICAgICAgfSlcbiAgICAgIH07XG4gICAgfVxuICAgIHRoaXMubWV0aG9kcyA9IG1ldGhvZHM7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbmFtZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGlmICh0aGlzLnRva2VuTmFtZSkge1xuICAgICAgcmV0dXJuIHRoaXMudG9rZW5OYW1lO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnJlYWRNZXRob2QoXCJuYW1lXCIsIHRoaXMuYWRkcmVzcyk7XG4gICAgY29uc3QgZGF0YSA9IEFiaS5kZWNvZGVQYXJhbWV0ZXIoXCJzdHJpbmdcIiwgcmVzdWx0KTtcbiAgICBpZiAoZGF0YS5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLnRva2VuTmFtZSA9IGRhdGFbMF07XG4gICAgICByZXR1cm4gdGhpcy50b2tlbk5hbWU7XG4gICAgfVxuICAgIHJldHVybiBcIlwiO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHN5bWJvbCgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGlmICh0aGlzLnRva2VuU3ltYm9sKSB7XG4gICAgICByZXR1cm4gdGhpcy50b2tlblN5bWJvbDtcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5yZWFkTWV0aG9kKFwic3ltYm9sXCIsIHRoaXMuYWRkcmVzcyk7XG4gICAgY29uc3QgZGF0YSA9IEFiaS5kZWNvZGVQYXJhbWV0ZXIoXCJzdHJpbmdcIiwgcmVzdWx0KTtcbiAgICBpZiAoZGF0YS5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLnRva2VuU3ltYm9sID0gZGF0YVswXTtcbiAgICAgIHJldHVybiB0aGlzLnRva2VuU3ltYm9sO1xuICAgIH1cbiAgICByZXR1cm4gXCJcIjtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZWNpbWFscygpOiBQcm9taXNlPEJpZ051bWJlcj4ge1xuICAgIGlmICh0aGlzLnRva2VuRGVjaW1hbHMpIHtcbiAgICAgIHJldHVybiB0aGlzLnRva2VuRGVjaW1hbHM7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVhZE1ldGhvZChcImRlY2ltYWxzXCIsIHRoaXMuYWRkcmVzcyk7XG4gICAgdGhpcy50b2tlbkRlY2ltYWxzID0gbmV3IEJpZ051bWJlcihyZXN1bHQsIDE2KTtcbiAgICByZXR1cm4gdGhpcy50b2tlbkRlY2ltYWxzO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHRvdGFsU3VwcGx5KCk6IFByb21pc2U8QmlnTnVtYmVyPiB7XG4gICAgaWYgKHRoaXMudG9rZW5Ub3RhbFN1cHBseSkge1xuICAgICAgcmV0dXJuIHRoaXMudG9rZW5Ub3RhbFN1cHBseTtcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5yZWFkTWV0aG9kKFwidG90YWxTdXBwbHlcIiwgdGhpcy5hZGRyZXNzKTtcbiAgICB0aGlzLnRva2VuVG90YWxTdXBwbHkgPSBuZXcgQmlnTnVtYmVyKHJlc3VsdCwgMTYpO1xuICAgIHJldHVybiB0aGlzLnRva2VuVG90YWxTdXBwbHk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgYmFsYW5jZU9mKG93bmVyOiBzdHJpbmcpOiBQcm9taXNlPEJpZ051bWJlcj4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVhZE1ldGhvZChcImJhbGFuY2VPZlwiLCB0aGlzLmFkZHJlc3MsIG93bmVyKTtcbiAgICByZXR1cm4gbmV3IEJpZ051bWJlcihyZXN1bHQsIDE2KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB0cmFuc2ZlcihcbiAgICB0bzogc3RyaW5nLFxuICAgIHZhbHVlOiBCaWdOdW1iZXIsXG4gICAgb3B0aW9uczogRXhlY3V0ZU9wdGlvblxuICApOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmV4ZWN1dGVNZXRob2QoXG4gICAgICBcInRyYW5zZmVyXCIsXG4gICAgICBvcHRpb25zLmFjY291bnQsXG4gICAgICBvcHRpb25zLmdhc1ByaWNlLFxuICAgICAgb3B0aW9ucy5nYXNMaW1pdCxcbiAgICAgIFwiMFwiLFxuICAgICAgdG8sXG4gICAgICB2YWx1ZS50b0ZpeGVkKDApXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBhbGxvd2FuY2UoXG4gICAgb3duZXI6IHN0cmluZyxcbiAgICBzcGVuZGVyOiBzdHJpbmcsXG4gICAgb3B0aW9uczogRXhlY3V0ZU9wdGlvblxuICApOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmV4ZWN1dGVNZXRob2QoXG4gICAgICBcImFsbG93YW5jZVwiLFxuICAgICAgb3B0aW9ucy5hY2NvdW50LFxuICAgICAgb3B0aW9ucy5nYXNQcmljZSxcbiAgICAgIG9wdGlvbnMuZ2FzTGltaXQsXG4gICAgICBcIjBcIixcbiAgICAgIG93bmVyLFxuICAgICAgc3BlbmRlclxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgYXBwcm92ZShcbiAgICBzcGVuZGVyOiBzdHJpbmcsXG4gICAgdmFsdWU6IEJpZ051bWJlcixcbiAgICBvcHRpb25zOiBFeGVjdXRlT3B0aW9uXG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuZXhlY3V0ZU1ldGhvZChcbiAgICAgIFwiYXBwcm92ZVwiLFxuICAgICAgb3B0aW9ucy5hY2NvdW50LFxuICAgICAgb3B0aW9ucy5nYXNQcmljZSxcbiAgICAgIG9wdGlvbnMuZ2FzTGltaXQsXG4gICAgICBcIjBcIixcbiAgICAgIHNwZW5kZXIsXG4gICAgICB2YWx1ZS50b0ZpeGVkKDApXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB0cmFuc2ZlckZyb20oXG4gICAgZnJvbTogc3RyaW5nLFxuICAgIHRvOiBzdHJpbmcsXG4gICAgdmFsdWU6IEJpZ051bWJlcixcbiAgICBvcHRpb25zOiBFeGVjdXRlT3B0aW9uXG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuZXhlY3V0ZU1ldGhvZChcbiAgICAgIFwidHJhbnNmZXJGcm9tXCIsXG4gICAgICBvcHRpb25zLmFjY291bnQsXG4gICAgICBvcHRpb25zLmdhc1ByaWNlLFxuICAgICAgb3B0aW9ucy5nYXNMaW1pdCxcbiAgICAgIFwiMFwiLFxuICAgICAgZnJvbSxcbiAgICAgIHRvLFxuICAgICAgdmFsdWUudG9GaXhlZCgwKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHJlYWRNZXRob2QoXG4gICAgbWV0aG9kOiBzdHJpbmcsXG4gICAgY2FsbGVyQWRkcmVzczogc3RyaW5nLFxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IHR5cGVkZWZcbiAgICAuLi5hcmdzXG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgaWYgKCF0aGlzLmNvbnRyYWN0LnByb3ZpZGVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJubyBycGMgbWV0aG9kIHByb3ZpZGVyIHNwZWNpZmllZFwiKTtcbiAgICB9XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmNvbnRyYWN0LnByb3ZpZGVyLnJlYWRDb250cmFjdCh7XG4gICAgICBleGVjdXRpb246IHRoaXMuY29udHJhY3QucHVyZUVuY29kZU1ldGhvZChcIjBcIiwgbWV0aG9kLCAuLi5hcmdzKSxcbiAgICAgIGNhbGxlckFkZHJlc3M6IGNhbGxlckFkZHJlc3NcbiAgICB9KTtcblxuICAgIHJldHVybiByZXN1bHQuZGF0YTtcbiAgfVxuXG4gIHByaXZhdGUgZXhlY3V0ZU1ldGhvZChcbiAgICBtZXRob2Q6IHN0cmluZyxcbiAgICBhY2NvdW50OiBBY2NvdW50LFxuICAgIGdhc1ByaWNlOiBzdHJpbmcsXG4gICAgZ2FzTGltaXQ6IHN0cmluZyxcbiAgICBhbW91bnQ6IHN0cmluZyxcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiB0eXBlZGVmXG4gICAgLi4uYXJnc1xuICApOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmNvbnRyYWN0Lm1ldGhvZHNbbWV0aG9kXSguLi5hcmdzLCB7XG4gICAgICBhY2NvdW50OiBhY2NvdW50LFxuICAgICAgYW1vdW50OiBhbW91bnQsXG4gICAgICBnYXNMaW1pdDogZ2FzTGltaXQsXG4gICAgICBnYXNQcmljZTogZ2FzUHJpY2VcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBkZWNvZGUoZGF0YTogc3RyaW5nKTogRGVjb2RlRGF0YSB7XG4gICAgaWYgKGRhdGEubGVuZ3RoIDwgOCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaW5wdXQgZGF0YSBlcnJvclwiKTtcbiAgICB9XG4gICAgY29uc3QgbWV0aG9kS2V5ID0gZGF0YS5zdWJzdHIoMCwgOCk7XG4gICAgY29uc3QgbWV0aG9kID0gdGhpcy5tZXRob2RzW21ldGhvZEtleV07XG4gICAgaWYgKCFtZXRob2QpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgbWV0aG9kICR7bWV0aG9kS2V5fSBpcyBub3QgZXJjMjAgbWV0aG9kYCk7XG4gICAgfVxuICAgIGNvbnN0IHBhcmFtcyA9IEFiaS5kZWNvZGVQYXJhbWV0ZXJzKG1ldGhvZC5pbnB1dHNUeXBlcywgZGF0YS5zdWJzdHJpbmcoOCkpO1xuICAgIGNvbnN0IHZhbHVlcyA9IHt9O1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtZXRob2QuaW5wdXRzVHlwZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChtZXRob2QuaW5wdXRzVHlwZXNbaV0gPT09IFwiYWRkcmVzc1wiKSB7XG4gICAgICAgIHBhcmFtc1tpXSA9IGZyb21CeXRlcyhcbiAgICAgICAgICBCdWZmZXIuZnJvbShwYXJhbXNbaV0uc3Vic3RyaW5nKDIpLCBcImhleFwiKVxuICAgICAgICApLnN0cmluZygpO1xuICAgICAgfVxuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgdmFsdWVzW21ldGhvZC5pbnB1dHNOYW1lc1tpXV0gPSBwYXJhbXNbaV07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIG1ldGhvZDogbWV0aG9kLm5hbWUsXG4gICAgICBkYXRhOiB2YWx1ZXNcbiAgICB9O1xuICB9XG59XG4iXX0=