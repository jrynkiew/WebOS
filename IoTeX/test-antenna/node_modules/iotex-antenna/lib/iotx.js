"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Iotx = void 0;

var _account = require("./account/account");

var _accounts = require("./account/accounts");

var _method = require("./action/method");

var _contract = require("./contract/contract");

var _rpcMethod = _interopRequireDefault(require("./rpc-method"));

var _address = require("./crypto/address");

var rlp = _interopRequireWildcard(require("rlp"));

var _bignumber = _interopRequireDefault(require("bignumber.js"));

var _ethereumjsUtil = require("ethereumjs-util");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class Iotx extends _rpcMethod.default {
  constructor(hostname, opts) {
    super(hostname, {
      timeout: opts && opts.timeout,
      apiToken: opts && opts.apiToken
    });

    _defineProperty(this, "accounts", void 0);

    _defineProperty(this, "signer", void 0);

    this.accounts = new _accounts.Accounts();
    this.signer = opts && opts.signer;
    setTimeout(async () => {
      const signer = this.signer;

      if (signer && signer.getAccounts) {
        try {
          const accounts = await signer.getAccounts();
          accounts.forEach(account => {
            this.accounts.addAccount(new _account.RemoteAccount(account.address, signer));
          });
        } catch (err) {
          throw new Error(`fetch remote accounts address error: ${err}`);
        }
      }
    }, 2000);
  }

  async tryGetAccount(address) {
    const sender = this.signer && this.signer.getAccount ? await this.signer.getAccount(address) : this.accounts.getAccount(address);

    if (!sender) {
      throw new Error(`cannot find account: ${address}`);
    }

    return sender;
  }

  currentProvider() {
    return this.client;
  }

  async sendTransfer(req) {
    const sender = await this.tryGetAccount(req.from);
    const payload = req.payload || "";
    return new _method.TransferMethod(this, sender, {
      gasLimit: req.gasLimit,
      gasPrice: req.gasPrice,
      amount: req.value,
      recipient: req.to,
      payload: payload
    }, {
      signer: this.signer
    }).execute();
  }

  async sendRawTransaction(req) {
    // @ts-ignore
    const tx = rlp.decode(req.data);
    const nonce = new _bignumber.default(`0x${tx[0].toString("hex")}`);
    const gasPrice = new _bignumber.default(`0x${tx[1].toString("hex")}`);
    const gasLimit = new _bignumber.default(`0x${tx[2].toString("hex")}`);
    let to = tx[3].length > 0 ? (0, _address.fromBytes)(tx[3]).string() : "";
    const value = new _bignumber.default(`0x${tx[4].toString("hex")}`);
    const data = tx[5];
    let v = new _bignumber.default(`0x${tx[6].toString("hex")}`);
    v = v.minus(req.chainID * 2 + 8);
    const pad = (0, _ethereumjsUtil.unpadBuffer)((0, _ethereumjsUtil.toBuffer)(0));
    const rawTx = [...tx.slice(0, 6), (0, _ethereumjsUtil.toBuffer)(req.chainID), pad, pad];
    const raw = rlp.encode(rawTx);
    const hash = (0, _ethereumjsUtil.keccakFromHexString)(`0x${raw.toString("hex")}`);
    const vv = (0, _ethereumjsUtil.bufferToInt)(tx[6]);
    const publicKey = (0, _ethereumjsUtil.ecrecover)(hash, vv, tx[7], tx[8], req.chainID);
    const compactPublicKey = Buffer.concat([(0, _ethereumjsUtil.toBuffer)(4), publicKey]);
    const signature = Buffer.concat([(0, _ethereumjsUtil.setLengthLeft)(tx[7], 32), (0, _ethereumjsUtil.setLengthLeft)(tx[8], 32), (0, _ethereumjsUtil.toBuffer)(v.toNumber())]);
    let isContract = true;

    if (to !== "") {
      const account = await this.getAccount({
        address: to
      });

      if (!account.accountMeta) {
        throw new Error(`can't fetch ${to} account info`);
      }

      isContract = account.accountMeta.isContract;
    }

    const sendActionReq = {
      action: {
        core: {
          version: 0,
          nonce: nonce.toString(10),
          gasLimit: gasLimit.toString(10),
          gasPrice: gasPrice.toString(10),
          chainID: 0
        },
        senderPubKey: compactPublicKey,
        signature: signature,
        encoding: 1
      }
    };

    if (!isContract) {
      // @ts-ignore
      sendActionReq.action.core.transfer = {
        amount: value.toString(10),
        recipient: to,
        payload: data
      };
    } else {
      // @ts-ignore
      sendActionReq.action.core.execution = {
        amount: value.toString(10),
        contract: to,
        data: data
      };
    }

    return (await this.sendAction(sendActionReq)).actionHash;
  }

  async estimateGas(req) {
    const to = req.to ? (0, _address.fromBytes)(Buffer.from(req.to.substring(2), "hex")).string() : "";
    let from = "io1qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqd39ym7";

    if (req.from) {
      from = (0, _address.fromBytes)(Buffer.from(req.from.substring(2), "hex")).string();
    }

    let isContract = true;

    if (to !== "") {
      const account = await this.getAccount({
        address: to
      });

      if (!account.accountMeta) {
        throw new Error(`can't fetch ${to} account info`);
      }

      isContract = account.accountMeta.isContract;
    }

    const estimateReq = {
      callerAddress: from
    };

    if (!isContract) {
      // @ts-ignore
      estimateReq.transfer = {
        amount: new _bignumber.default(req.value).toString(10),
        recipient: to,
        payload: req.data ? Buffer.from(req.data.substring(2), "hex") : ""
      };
    } else {
      // @ts-ignore
      estimateReq.execution = {
        amount: req.value ? new _bignumber.default(req.value).toString(10) : "0",
        contract: to,
        data: req.data ? Buffer.from(req.data.substring(2), "hex") : ""
      };
    }

    return (await this.estimateActionGasConsumption(estimateReq)).gas;
  } // return action hash


  async deployContract(req, ...args) {
    if (typeof req.abi === "string") {
      try {
        req.abi = JSON.parse(req.abi);
      } catch (e) {
        throw new Error("parse abi to ABIDefinition error");
      }
    }

    const sender = await this.tryGetAccount(req.from); // @ts-ignore

    return new _contract.Contract(req.abi, undefined, {
      data: req.data,
      provider: this,
      signer: this.signer
    }).deploy(sender, args, req.amount, req.gasLimit, req.gasPrice);
  } // return action hash


  async executeContract(req, ...args) {
    if (typeof req.abi === "string") {
      try {
        req.abi = JSON.parse(req.abi);
      } catch (e) {
        throw new Error("parse abi to ABIDefinition error");
      }
    }

    const sender = await this.tryGetAccount(req.from); // @ts-ignore

    const contract = new _contract.Contract(req.abi, req.contractAddress, {
      provider: this,
      signer: this.signer
    });
    return contract.methods[req.method](...args, {
      account: sender,
      amount: req.amount,
      gasLimit: req.gasLimit,
      gasPrice: req.gasPrice
    });
  }

  async readContractByMethod(req, ...args) {
    if (typeof req.abi === "string") {
      try {
        req.abi = JSON.parse(req.abi);
      } catch (e) {
        throw new Error("parse abi to ABIDefinition error");
      }
    } // @ts-ignore


    const contract = new _contract.Contract(req.abi, req.contractAddress, {
      provider: this,
      signer: this.signer
    });
    const result = await this.readContract({
      execution: contract.pureEncodeMethod("0", req.method, ...args),
      callerAddress: req.from
    });
    return contract.decodeMethodResult(req.method, result.data);
  }

  async claimFromRewardingFund(req) {
    const sender = await this.tryGetAccount(req.from);
    return new _method.ClaimFromRewardingFundMethod(this, sender, {
      gasLimit: req.gasLimit,
      gasPrice: req.gasPrice,
      amount: req.amount,
      data: req.data
    }, {
      signer: this.signer
    }).execute();
  }

}

exports.Iotx = Iotx;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pb3R4LnRzIl0sIm5hbWVzIjpbIklvdHgiLCJScGNNZXRob2QiLCJjb25zdHJ1Y3RvciIsImhvc3RuYW1lIiwib3B0cyIsInRpbWVvdXQiLCJhcGlUb2tlbiIsImFjY291bnRzIiwiQWNjb3VudHMiLCJzaWduZXIiLCJzZXRUaW1lb3V0IiwiZ2V0QWNjb3VudHMiLCJmb3JFYWNoIiwiYWNjb3VudCIsImFkZEFjY291bnQiLCJSZW1vdGVBY2NvdW50IiwiYWRkcmVzcyIsImVyciIsIkVycm9yIiwidHJ5R2V0QWNjb3VudCIsInNlbmRlciIsImdldEFjY291bnQiLCJjdXJyZW50UHJvdmlkZXIiLCJjbGllbnQiLCJzZW5kVHJhbnNmZXIiLCJyZXEiLCJmcm9tIiwicGF5bG9hZCIsIlRyYW5zZmVyTWV0aG9kIiwiZ2FzTGltaXQiLCJnYXNQcmljZSIsImFtb3VudCIsInZhbHVlIiwicmVjaXBpZW50IiwidG8iLCJleGVjdXRlIiwic2VuZFJhd1RyYW5zYWN0aW9uIiwidHgiLCJybHAiLCJkZWNvZGUiLCJkYXRhIiwibm9uY2UiLCJCaWdOdW1iZXIiLCJ0b1N0cmluZyIsImxlbmd0aCIsInN0cmluZyIsInYiLCJtaW51cyIsImNoYWluSUQiLCJwYWQiLCJyYXdUeCIsInNsaWNlIiwicmF3IiwiZW5jb2RlIiwiaGFzaCIsInZ2IiwicHVibGljS2V5IiwiY29tcGFjdFB1YmxpY0tleSIsIkJ1ZmZlciIsImNvbmNhdCIsInNpZ25hdHVyZSIsInRvTnVtYmVyIiwiaXNDb250cmFjdCIsImFjY291bnRNZXRhIiwic2VuZEFjdGlvblJlcSIsImFjdGlvbiIsImNvcmUiLCJ2ZXJzaW9uIiwic2VuZGVyUHViS2V5IiwiZW5jb2RpbmciLCJ0cmFuc2ZlciIsImV4ZWN1dGlvbiIsImNvbnRyYWN0Iiwic2VuZEFjdGlvbiIsImFjdGlvbkhhc2giLCJlc3RpbWF0ZUdhcyIsInN1YnN0cmluZyIsImVzdGltYXRlUmVxIiwiY2FsbGVyQWRkcmVzcyIsImVzdGltYXRlQWN0aW9uR2FzQ29uc3VtcHRpb24iLCJnYXMiLCJkZXBsb3lDb250cmFjdCIsImFyZ3MiLCJhYmkiLCJKU09OIiwicGFyc2UiLCJlIiwiQ29udHJhY3QiLCJ1bmRlZmluZWQiLCJwcm92aWRlciIsImRlcGxveSIsImV4ZWN1dGVDb250cmFjdCIsImNvbnRyYWN0QWRkcmVzcyIsIm1ldGhvZHMiLCJtZXRob2QiLCJyZWFkQ29udHJhY3RCeU1ldGhvZCIsInJlc3VsdCIsInJlYWRDb250cmFjdCIsInB1cmVFbmNvZGVNZXRob2QiLCJkZWNvZGVNZXRob2RSZXN1bHQiLCJjbGFpbUZyb21SZXdhcmRpbmdGdW5kIiwiQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZE1ldGhvZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBOztBQUNBOztBQUNBOztBQUtBOztBQUNBOztBQVVBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7Ozs7O0FBZU8sTUFBTUEsSUFBTixTQUFtQkMsa0JBQW5CLENBQTZCO0FBSWxDQyxFQUFBQSxXQUFXLENBQUNDLFFBQUQsRUFBbUJDLElBQW5CLEVBQW9DO0FBQzdDLFVBQU1ELFFBQU4sRUFBZ0I7QUFDZEUsTUFBQUEsT0FBTyxFQUFFRCxJQUFJLElBQUlBLElBQUksQ0FBQ0MsT0FEUjtBQUVkQyxNQUFBQSxRQUFRLEVBQUVGLElBQUksSUFBSUEsSUFBSSxDQUFDRTtBQUZULEtBQWhCOztBQUQ2Qzs7QUFBQTs7QUFLN0MsU0FBS0MsUUFBTCxHQUFnQixJQUFJQyxrQkFBSixFQUFoQjtBQUNBLFNBQUtDLE1BQUwsR0FBY0wsSUFBSSxJQUFJQSxJQUFJLENBQUNLLE1BQTNCO0FBQ0FDLElBQUFBLFVBQVUsQ0FBQyxZQUFZO0FBQ3JCLFlBQU1ELE1BQU0sR0FBRyxLQUFLQSxNQUFwQjs7QUFDQSxVQUFJQSxNQUFNLElBQUlBLE1BQU0sQ0FBQ0UsV0FBckIsRUFBa0M7QUFDaEMsWUFBSTtBQUNGLGdCQUFNSixRQUFRLEdBQUcsTUFBTUUsTUFBTSxDQUFDRSxXQUFQLEVBQXZCO0FBQ0FKLFVBQUFBLFFB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dCI6WyIvKiB0c2xpbnQ6ZGlzYWJsZTpuby1hbnkgKi9cbmltcG9ydCB7IEFjY291bnQsIFJlbW90ZUFjY291bnQgfSBmcm9tIFwiLi9hY2NvdW50L2FjY291bnRcIjtcbmltcG9ydCB7IEFjY291bnRzIH0gZnJvbSBcIi4vYWNjb3VudC9hY2NvdW50c1wiO1xuaW1wb3J0IHtcbiAgQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZE1ldGhvZCxcbiAgU2lnbmVyUGx1Z2luLFxuICBUcmFuc2Zlck1ldGhvZFxufSBmcm9tIFwiLi9hY3Rpb24vbWV0aG9kXCI7XG5pbXBvcnQgeyBDb250cmFjdCB9IGZyb20gXCIuL2NvbnRyYWN0L2NvbnRyYWN0XCI7XG5pbXBvcnQgUnBjTWV0aG9kIGZyb20gXCIuL3JwYy1tZXRob2RcIjtcbmltcG9ydCB7IElScGNNZXRob2QgfSBmcm9tIFwiLi9ycGMtbWV0aG9kL3R5cGVzXCI7XG5pbXBvcnQge1xuICBDbGFpbUZyb21SZXdhcmRpbmdGdW5kUmVxdXNldCxcbiAgQ29udHJhY3RSZXF1ZXN0LFxuICBFc3RpbWF0ZUdhc1JlcXVlc3QsXG4gIEV4ZWN1dGVDb250cmFjdFJlcXVlc3QsXG4gIFJhd1RyYW5zYWN0aW9uUmVxdWVzdCxcbiAgVHJhbnNmZXJSZXF1ZXN0XG59IGZyb20gXCIuL3R5cGVzXCI7XG5pbXBvcnQgeyBmcm9tQnl0ZXMgfSBmcm9tIFwiLi9jcnlwdG8vYWRkcmVzc1wiO1xuaW1wb3J0ICogYXMgcmxwIGZyb20gXCJybHBcIjtcbmltcG9ydCBCaWdOdW1iZXIgZnJvbSBcImJpZ251bWJlci5qc1wiO1xuaW1wb3J0IHtcbiAgZWNyZWNvdmVyLFxuICBrZWNjYWtGcm9tSGV4U3RyaW5nLFxuICB0b0J1ZmZlcixcbiAgdW5wYWRCdWZmZXIsXG4gIGJ1ZmZlclRvSW50LFxuICBzZXRMZW5ndGhMZWZ0XG59IGZyb20gXCJldGhlcmV1bWpzLXV0aWxcIjtcblxudHlwZSBJb3R4T3B0cyA9IHtcbiAgc2lnbmVyPzogU2lnbmVyUGx1Z2luO1xuICB0aW1lb3V0PzogbnVtYmVyO1xuICBhcGlUb2tlbj86IHN0cmluZztcbn07XG5cbmV4cG9ydCBjbGFzcyBJb3R4IGV4dGVuZHMgUnBjTWV0aG9kIHtcbiAgcHVibGljIGFjY291bnRzOiBBY2NvdW50cztcbiAgcHVibGljIHNpZ25lcj86IFNpZ25lclBsdWdpbjtcblxuICBjb25zdHJ1Y3Rvcihob3N0bmFtZTogc3RyaW5nLCBvcHRzPzogSW90eE9wdHMpIHtcbiAgICBzdXBlcihob3N0bmFtZSwge1xuICAgICAgdGltZW91dDogb3B0cyAmJiBvcHRzLnRpbWVvdXQsXG4gICAgICBhcGlUb2tlbjogb3B0cyAmJiBvcHRzLmFwaVRva2VuXG4gICAgfSk7XG4gICAgdGhpcy5hY2NvdW50cyA9IG5ldyBBY2NvdW50cygpO1xuICAgIHRoaXMuc2lnbmVyID0gb3B0cyAmJiBvcHRzLnNpZ25lcjtcbiAgICBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHNpZ25lciA9IHRoaXMuc2lnbmVyO1xuICAgICAgaWYgKHNpZ25lciAmJiBzaWduZXIuZ2V0QWNjb3VudHMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCBhY2NvdW50cyA9IGF3YWl0IHNpZ25lci5nZXRBY2NvdW50cygpO1xuICAgICAgICAgIGFjY291bnRzLmZvckVhY2goYWNjb3VudCA9PiB7XG4gICAgICAgICAgICB0aGlzLmFjY291bnRzLmFkZEFjY291bnQoXG4gICAgICAgICAgICAgIG5ldyBSZW1vdGVBY2NvdW50KGFjY291bnQuYWRkcmVzcywgc2lnbmVyKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBmZXRjaCByZW1vdGUgYWNjb3VudHMgYWRkcmVzcyBlcnJvcjogJHtlcnJ9YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LCAyMDAwKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB0cnlHZXRBY2NvdW50KGFkZHJlc3M6IHN0cmluZyk6IFByb21pc2U8QWNjb3VudD4ge1xuICAgIGNvbnN0IHNlbmRlciA9XG4gICAgICB0aGlzLnNpZ25lciAmJiB0aGlzLnNpZ25lci5nZXRBY2NvdW50XG4gICAgICAgID8gYXdhaXQgdGhpcy5zaWduZXIuZ2V0QWNjb3VudChhZGRyZXNzKVxuICAgICAgICA6IHRoaXMuYWNjb3VudHMuZ2V0QWNjb3VudChhZGRyZXNzKTtcbiAgICBpZiAoIXNlbmRlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBjYW5ub3QgZmluZCBhY2NvdW50OiAke2FkZHJlc3N9YCk7XG4gICAgfVxuICAgIHJldHVybiBzZW5kZXI7XG4gIH1cblxuICBwdWJsaWMgY3VycmVudFByb3ZpZGVyKCk6IElScGNNZXRob2Qge1xuICAgIHJldHVybiB0aGlzLmNsaWVudDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZW5kVHJhbnNmZXIocmVxOiBUcmFuc2ZlclJlcXVlc3QpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IHNlbmRlciA9IGF3YWl0IHRoaXMudHJ5R2V0QWNjb3VudChyZXEuZnJvbSk7XG4gICAgY29uc3QgcGF5bG9hZCA9IHJlcS5wYXlsb2FkIHx8IFwiXCI7XG4gICAgcmV0dXJuIG5ldyBUcmFuc2Zlck1ldGhvZChcbiAgICAgIHRoaXMsXG4gICAgICBzZW5kZXIsXG4gICAgICB7XG4gICAgICAgIGdhc0xpbWl0OiByZXEuZ2FzTGltaXQsXG4gICAgICAgIGdhc1ByaWNlOiByZXEuZ2FzUHJpY2UsXG4gICAgICAgIGFtb3VudDogcmVxLnZhbHVlLFxuICAgICAgICByZWNpcGllbnQ6IHJlcS50byxcbiAgICAgICAgcGF5bG9hZDogcGF5bG9hZFxuICAgICAgfSxcbiAgICAgIHsgc2lnbmVyOiB0aGlzLnNpZ25lciB9XG4gICAgKS5leGVjdXRlKCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2VuZFJhd1RyYW5zYWN0aW9uKHJlcTogUmF3VHJhbnNhY3Rpb25SZXF1ZXN0KTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgY29uc3QgdHg6IEJ1ZmZlcltdID0gcmxwLmRlY29kZShyZXEuZGF0YSk7XG5cbiAgICBjb25zdCBub25jZSA9IG5ldyBCaWdOdW1iZXIoYDB4JHt0eFswXS50b1N0cmluZyhcImhleFwiKX1gKTtcbiAgICBjb25zdCBnYXNQcmljZSA9IG5ldyBCaWdOdW1iZXIoYDB4JHt0eFsxXS50b1N0cmluZyhcImhleFwiKX1gKTtcbiAgICBjb25zdCBnYXNMaW1pdCA9IG5ldyBCaWdOdW1iZXIoYDB4JHt0eFsyXS50b1N0cmluZyhcImhleFwiKX1gKTtcbiAgICBsZXQgdG8gPSB0eFszXS5sZW5ndGggPiAwID8gZnJvbUJ5dGVzKHR4WzNdKS5zdHJpbmcoKSA6IFwiXCI7XG4gICAgY29uc3QgdmFsdWUgPSBuZXcgQmlnTnVtYmVyKGAweCR7dHhbNF0udG9TdHJpbmcoXCJoZXhcIil9YCk7XG4gICAgY29uc3QgZGF0YSA9IHR4WzVdO1xuICAgIGxldCB2ID0gbmV3IEJpZ051bWJlcihgMHgke3R4WzZdLnRvU3RyaW5nKFwiaGV4XCIpfWApO1xuICAgIHYgPSB2Lm1pbnVzKHJlcS5jaGFpbklEICogMiArIDgpO1xuXG4gICAgY29uc3QgcGFkID0gdW5wYWRCdWZmZXIodG9CdWZmZXIoMCkpO1xuICAgIGNvbnN0IHJhd1R4ID0gWy4uLnR4LnNsaWNlKDAsIDYpLCB0b0J1ZmZlcihyZXEuY2hhaW5JRCksIHBhZCwgcGFkXTtcblxuICAgIGNvbnN0IHJhdyA9IHJscC5lbmNvZGUocmF3VHgpO1xuICAgIGNvbnN0IGhhc2ggPSBrZWNjYWtGcm9tSGV4U3RyaW5nKGAweCR7cmF3LnRvU3RyaW5nKFwiaGV4XCIpfWApO1xuXG4gICAgY29uc3QgdnYgPSBidWZmZXJUb0ludCh0eFs2XSk7XG4gICAgY29uc3QgcHVibGljS2V5ID0gZWNyZWNvdmVyKGhhc2gsIHZ2LCB0eFs3XSwgdHhbOF0sIHJlcS5jaGFpbklEKTtcbiAgICBjb25zdCBjb21wYWN0UHVibGljS2V5ID0gQnVmZmVyLmNvbmNhdChbdG9CdWZmZXIoNCksIHB1YmxpY0tleV0pO1xuICAgIGNvbnN0IHNpZ25hdHVyZSA9IEJ1ZmZlci5jb25jYXQoW1xuICAgICAgc2V0TGVuZ3RoTGVmdCh0eFs3XSwgMzIpLFxuICAgICAgc2V0TGVuZ3RoTGVmdCh0eFs4XSwgMzIpLFxuICAgICAgdG9CdWZmZXIodi50b051bWJlcigpKVxuICAgIF0pO1xuXG4gICAgbGV0IGlzQ29udHJhY3QgPSB0cnVlO1xuICAgIGlmICh0byAhPT0gXCJcIikge1xuICAgICAgY29uc3QgYWNjb3VudCA9IGF3YWl0IHRoaXMuZ2V0QWNjb3VudCh7XG4gICAgICAgIGFkZHJlc3M6IHRvXG4gICAgICB9KTtcbiAgICAgIGlmICghYWNjb3VudC5hY2NvdW50TWV0YSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGNhbid0IGZldGNoICR7dG99IGFjY291bnQgaW5mb2ApO1xuICAgICAgfVxuICAgICAgaXNDb250cmFjdCA9IGFjY291bnQuYWNjb3VudE1ldGEuaXNDb250cmFjdDtcbiAgICB9XG5cbiAgICBjb25zdCBzZW5kQWN0aW9uUmVxID0ge1xuICAgICAgYWN0aW9uOiB7XG4gICAgICAgIGNvcmU6IHtcbiAgICAgICAgICB2ZXJzaW9uOiAwLFxuICAgICAgICAgIG5vbmNlOiBub25jZS50b1N0cmluZygxMCksXG4gICAgICAgICAgZ2FzTGltaXQ6IGdhc0xpbWl0LnRvU3RyaW5nKDEwKSxcbiAgICAgICAgICBnYXNQcmljZTogZ2FzUHJpY2UudG9TdHJpbmcoMTApLFxuICAgICAgICAgIGNoYWluSUQ6IDBcbiAgICAgICAgfSxcbiAgICAgICAgc2VuZGVyUHViS2V5OiBjb21wYWN0UHVibGljS2V5LFxuICAgICAgICBzaWduYXR1cmU6IHNpZ25hdHVyZSxcbiAgICAgICAgZW5jb2Rpbmc6IDFcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgaWYgKCFpc0NvbnRyYWN0KSB7XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBzZW5kQWN0aW9uUmVxLmFjdGlvbi5jb3JlLnRyYW5zZmVyID0ge1xuICAgICAgICBhbW91bnQ6IHZhbHVlLnRvU3RyaW5nKDEwKSxcbiAgICAgICAgcmVjaXBpZW50OiB0byxcbiAgICAgICAgcGF5bG9hZDogZGF0YVxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgc2VuZEFjdGlvblJlcS5hY3Rpb24uY29yZS5leGVjdXRpb24gPSB7XG4gICAgICAgIGFtb3VudDogdmFsdWUudG9TdHJpbmcoMTApLFxuICAgICAgICBjb250cmFjdDogdG8sXG4gICAgICAgIGRhdGE6IGRhdGFcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLnNlbmRBY3Rpb24oc2VuZEFjdGlvblJlcSkpLmFjdGlvbkhhc2g7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZXN0aW1hdGVHYXMocmVxOiBFc3RpbWF0ZUdhc1JlcXVlc3QpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IHRvID0gcmVxLnRvXG4gICAgICA/IGZyb21CeXRlcyhCdWZmZXIuZnJvbShyZXEudG8uc3Vic3RyaW5nKDIpLCBcImhleFwiKSkuc3RyaW5nKClcbiAgICAgIDogXCJcIjtcbiAgICBsZXQgZnJvbSA9IFwiaW8xcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFkMzl5bTdcIjtcbiAgICBpZiAocmVxLmZyb20pIHtcbiAgICAgIGZyb20gPSBmcm9tQnl0ZXMoQnVmZmVyLmZyb20ocmVxLmZyb20uc3Vic3RyaW5nKDIpLCBcImhleFwiKSkuc3RyaW5nKCk7XG4gICAgfVxuXG4gICAgbGV0IGlzQ29udHJhY3QgPSB0cnVlO1xuICAgIGlmICh0byAhPT0gXCJcIikge1xuICAgICAgY29uc3QgYWNjb3VudCA9IGF3YWl0IHRoaXMuZ2V0QWNjb3VudCh7XG4gICAgICAgIGFkZHJlc3M6IHRvXG4gICAgICB9KTtcbiAgICAgIGlmICghYWNjb3VudC5hY2NvdW50TWV0YSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGNhbid0IGZldGNoICR7dG99IGFjY291bnQgaW5mb2ApO1xuICAgICAgfVxuICAgICAgaXNDb250cmFjdCA9IGFjY291bnQuYWNjb3VudE1ldGEuaXNDb250cmFjdDtcbiAgICB9XG5cbiAgICBjb25zdCBlc3RpbWF0ZVJlcSA9IHtcbiAgICAgIGNhbGxlckFkZHJlc3M6IGZyb21cbiAgICB9O1xuICAgIGlmICghaXNDb250cmFjdCkge1xuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgZXN0aW1hdGVSZXEudHJhbnNmZXIgPSB7XG4gICAgICAgIGFtb3VudDogbmV3IEJpZ051bWJlcihyZXEudmFsdWUhKS50b1N0cmluZygxMCksXG4gICAgICAgIHJlY2lwaWVudDogdG8sXG4gICAgICAgIHBheWxvYWQ6IHJlcS5kYXRhID8gQnVmZmVyLmZyb20ocmVxLmRhdGEuc3Vic3RyaW5nKDIpLCBcImhleFwiKSA6IFwiXCJcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIGVzdGltYXRlUmVxLmV4ZWN1dGlvbiA9IHtcbiAgICAgICAgYW1vdW50OiByZXEudmFsdWUgPyBuZXcgQmlnTnVtYmVyKHJlcS52YWx1ZSkudG9TdHJpbmcoMTApIDogXCIwXCIsXG4gICAgICAgIGNvbnRyYWN0OiB0byxcbiAgICAgICAgZGF0YTogcmVxLmRhdGEgPyBCdWZmZXIuZnJvbShyZXEuZGF0YS5zdWJzdHJpbmcoMiksIFwiaGV4XCIpIDogXCJcIlxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZXN0aW1hdGVBY3Rpb25HYXNDb25zdW1wdGlvbihlc3RpbWF0ZVJlcSkpLmdhcztcbiAgfVxuXG4gIC8vIHJldHVybiBhY3Rpb24gaGFzaFxuICBwdWJsaWMgYXN5bmMgZGVwbG95Q29udHJhY3QoXG4gICAgcmVxOiBDb250cmFjdFJlcXVlc3QsXG4gICAgLi4uYXJnczogQXJyYXk8YW55PlxuICApOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGlmICh0eXBlb2YgcmVxLmFiaSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmVxLmFiaSA9IEpTT04ucGFyc2UocmVxLmFiaSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcInBhcnNlIGFiaSB0byBBQklEZWZpbml0aW9uIGVycm9yXCIpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHNlbmRlciA9IGF3YWl0IHRoaXMudHJ5R2V0QWNjb3VudChyZXEuZnJvbSk7XG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcmV0dXJuIG5ldyBDb250cmFjdChyZXEuYWJpLCB1bmRlZmluZWQsIHtcbiAgICAgIGRhdGE6IHJlcS5kYXRhLFxuICAgICAgcHJvdmlkZXI6IHRoaXMsXG4gICAgICBzaWduZXI6IHRoaXMuc2lnbmVyXG4gICAgfSkuZGVwbG95KHNlbmRlciwgYXJncywgcmVxLmFtb3VudCwgcmVxLmdhc0xpbWl0LCByZXEuZ2FzUHJpY2UpO1xuICB9XG5cbiAgLy8gcmV0dXJuIGFjdGlvbiBoYXNoXG4gIHB1YmxpYyBhc3luYyBleGVjdXRlQ29udHJhY3QoXG4gICAgcmVxOiBFeGVjdXRlQ29udHJhY3RSZXF1ZXN0LFxuICAgIC4uLmFyZ3M6IEFycmF5PGFueT5cbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBpZiAodHlwZW9mIHJlcS5hYmkgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJlcS5hYmkgPSBKU09OLnBhcnNlKHJlcS5hYmkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJwYXJzZSBhYmkgdG8gQUJJRGVmaW5pdGlvbiBlcnJvclwiKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBzZW5kZXIgPSBhd2FpdCB0aGlzLnRyeUdldEFjY291bnQocmVxLmZyb20pO1xuXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0IGNvbnRyYWN0ID0gbmV3IENvbnRyYWN0KHJlcS5hYmksIHJlcS5jb250cmFjdEFkZHJlc3MsIHtcbiAgICAgIHByb3ZpZGVyOiB0aGlzLFxuICAgICAgc2lnbmVyOiB0aGlzLnNpZ25lclxuICAgIH0pO1xuICAgIHJldHVybiBjb250cmFjdC5tZXRob2RzW3JlcS5tZXRob2RdKC4uLmFyZ3MsIHtcbiAgICAgIGFjY291bnQ6IHNlbmRlcixcbiAgICAgIGFtb3VudDogcmVxLmFtb3VudCxcbiAgICAgIGdhc0xpbWl0OiByZXEuZ2FzTGltaXQsXG4gICAgICBnYXNQcmljZTogcmVxLmdhc1ByaWNlXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVhZENvbnRyYWN0QnlNZXRob2QoXG4gICAgcmVxOiBFeGVjdXRlQ29udHJhY3RSZXF1ZXN0LFxuICAgIC4uLmFyZ3M6IEFycmF5PGFueT5cbiAgKTogUHJvbWlzZTxhbnkgfCBBcnJheTxhbnk+PiB7XG4gICAgaWYgKHR5cGVvZiByZXEuYWJpID09PSBcInN0cmluZ1wiKSB7XG4gICAgICB0cnkge1xuICAgICAgICByZXEuYWJpID0gSlNPTi5wYXJzZShyZXEuYWJpKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwicGFyc2UgYWJpIHRvIEFCSURlZmluaXRpb24gZXJyb3JcIik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0IGNvbnRyYWN0ID0gbmV3IENvbnRyYWN0KHJlcS5hYmksIHJlcS5jb250cmFjdEFkZHJlc3MsIHtcbiAgICAgIHByb3ZpZGVyOiB0aGlzLFxuICAgICAgc2lnbmVyOiB0aGlzLnNpZ25lclxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5yZWFkQ29udHJhY3Qoe1xuICAgICAgZXhlY3V0aW9uOiBjb250cmFjdC5wdXJlRW5jb2RlTWV0aG9kKFwiMFwiLCByZXEubWV0aG9kLCAuLi5hcmdzKSxcbiAgICAgIGNhbGxlckFkZHJlc3M6IHJlcS5mcm9tXG4gICAgfSk7XG5cbiAgICByZXR1cm4gY29udHJhY3QuZGVjb2RlTWV0aG9kUmVzdWx0KHJlcS5tZXRob2QsIHJlc3VsdC5kYXRhKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjbGFpbUZyb21SZXdhcmRpbmdGdW5kKFxuICAgIHJlcTogQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZFJlcXVzZXRcbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBzZW5kZXIgPSBhd2FpdCB0aGlzLnRyeUdldEFjY291bnQocmVxLmZyb20pO1xuXG4gICAgcmV0dXJuIG5ldyBDbGFpbUZyb21SZXdhcmRpbmdGdW5kTWV0aG9kKFxuICAgICAgdGhpcyxcbiAgICAgIHNlbmRlcixcbiAgICAgIHtcbiAgICAgICAgZ2FzTGltaXQ6IHJlcS5nYXNMaW1pdCxcbiAgICAgICAgZ2FzUHJpY2U6IHJlcS5nYXNQcmljZSxcbiAgICAgICAgYW1vdW50OiByZXEuYW1vdW50LFxuICAgICAgICBkYXRhOiByZXEuZGF0YVxuICAgICAgfSxcbiAgICAgIHsgc2lnbmVyOiB0aGlzLnNpZ25lciB9XG4gICAgKS5leGVjdXRlKCk7XG4gIH1cbn1cbiJdfQ==