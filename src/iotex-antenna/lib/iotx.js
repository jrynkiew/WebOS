"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Iotx = void 0;

var _account = require("./account/account");

var _accounts = require("./account/accounts");

var _method = require("./action/method");

var _contract = require("./contract/contract");

var _rpcMethod = _interopRequireDefault(require("./rpc-method"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class Iotx extends _rpcMethod.default {
  constructor(hostname, opts) {
    super(hostname, {
      timeout: opts && opts.timeout,
      apiToken: opts && opts.apiToken
    });

    _defineProperty(this, "accounts", void 0);

    _defineProperty(this, "signer", void 0);

    this.accounts = new _accounts.Accounts();
    this.signer = opts && opts.signer;
    setTimeout(async () => {
      const signer = this.signer;

      if (signer && signer.getAccounts) {
        try {
          const accounts = await signer.getAccounts();
          accounts.forEach(account => {
            this.accounts.addAccount(new _account.RemoteAccount(account.address, signer));
          });
        } catch (err) {
          throw new Error(`fetch remote accounts address error: ${err}`);
        }
      }
    }, 2000);
  }

  async tryGetAccount(address) {
    const sender = this.signer && this.signer.getAccount ? await this.signer.getAccount(address) : this.accounts.getAccount(address);

    if (!sender) {
      throw new Error(`cannot find account: ${address}`);
    }

    return sender;
  }

  currentProvider() {
    return this.client;
  }

  async sendTransfer(req) {
    const sender = await this.tryGetAccount(req.from);
    const payload = req.payload || "";
    return new _method.TransferMethod(this, sender, {
      gasLimit: req.gasLimit,
      gasPrice: req.gasPrice,
      amount: req.value,
      recipient: req.to,
      payload: payload
    }, {
      signer: this.signer
    }).execute();
  } // return action hash


  async deployContract(req, ...args) {
    if (typeof req.abi === "string") {
      try {
        req.abi = JSON.parse(req.abi);
      } catch (e) {
        throw new Error("parse abi to ABIDefinition error");
      }
    }

    const sender = await this.tryGetAccount(req.from); // @ts-ignore

    return new _contract.Contract(req.abi, undefined, {
      data: req.data,
      provider: this,
      signer: this.signer
    }).deploy(sender, args, req.amount, req.gasLimit, req.gasPrice);
  } // return action hash


  async executeContract(req, ...args) {
    if (typeof req.abi === "string") {
      try {
        req.abi = JSON.parse(req.abi);
      } catch (e) {
        throw new Error("parse abi to ABIDefinition error");
      }
    }

    const sender = await this.tryGetAccount(req.from); // @ts-ignore

    const contract = new _contract.Contract(req.abi, req.contractAddress, {
      provider: this,
      signer: this.signer
    });
    return contract.methods[req.method](...args, {
      account: sender,
      amount: req.amount,
      gasLimit: req.gasLimit,
      gasPrice: req.gasPrice
    });
  }

  async readContractByMethod(req, ...args) {
    if (typeof req.abi === "string") {
      try {
        req.abi = JSON.parse(req.abi);
      } catch (e) {
        throw new Error("parse abi to ABIDefinition error");
      }
    } // @ts-ignore


    const contract = new _contract.Contract(req.abi, req.contractAddress, {
      provider: this,
      signer: this.signer
    });
    const result = await this.readContract({
      execution: contract.pureEncodeMethod("0", req.method, ...args),
      callerAddress: req.from
    });
    return contract.decodeMethodResult(req.method, result.data);
  }

  async claimFromRewardingFund(req) {
    const sender = await this.tryGetAccount(req.from);
    return new _method.ClaimFromRewardingFundMethod(this, sender, {
      gasLimit: req.gasLimit,
      gasPrice: req.gasPrice,
      amount: req.amount,
      data: req.data
    }, {
      signer: this.signer
    }).execute();
  }

}

exports.Iotx = Iotx;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pb3R4LnRzIl0sIm5hbWVzIjpbIklvdHgiLCJScGNNZXRob2QiLCJjb25zdHJ1Y3RvciIsImhvc3RuYW1lIiwib3B0cyIsInRpbWVvdXQiLCJhcGlUb2tlbiIsImFjY291bnRzIiwiQWNjb3VudHMiLCJzaWduZXIiLCJzZXRUaW1lb3V0IiwiZ2V0QWNjb3VudHMiLCJmb3JFYWNoIiwiYWNjb3VudCIsImFkZEFjY291bnQiLCJSZW1vdGVBY2NvdW50IiwiYWRkcmVzcyIsImVyciIsIkVycm9yIiwidHJ5R2V0QWNjb3VudCIsInNlbmRlciIsImdldEFjY291bnQiLCJjdXJyZW50UHJvdmlkZXIiLCJjbGllbnQiLCJzZW5kVHJhbnNmZXIiLCJyZXEiLCJmcm9tIiwicGF5bG9hZCIsIlRyYW5zZmVyTWV0aG9kIiwiZ2FzTGltaXQiLCJnYXNQcmljZSIsImFtb3VudCIsInZhbHVlIiwicmVjaXBpZW50IiwidG8iLCJleGVjdXRlIiwiZGVwbG95Q29udHJhY3QiLCJhcmdzIiwiYWJpIiwiSlNPTiIsInBhcnNlIiwiZSIsIkNvbnRyYWN0IiwidW5kZWZpbmVkIiwiZGF0YSIsInByb3ZpZGVyIiwiZGVwbG95IiwiZXhlY3V0ZUNvbnRyYWN0IiwiY29udHJhY3QiLCJjb250cmFjdEFkZHJlc3MiLCJtZXRob2RzIiwibWV0aG9kIiwicmVhZENvbnRyYWN0QnlNZXRob2QiLCJyZXN1bHQiLCJyZWFkQ29udHJhY3QiLCJleGVjdXRpb24iLCJwdXJlRW5jb2RlTWV0aG9kIiwiY2FsbGVyQWRkcmVzcyIsImRlY29kZU1ldGhvZFJlc3VsdCIsImNsYWltRnJvbVJld2FyZGluZ0Z1bmQiLCJDbGFpbUZyb21SZXdhcmRpbmdGdW5kTWV0aG9kIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBS0E7O0FBQ0E7Ozs7OztBQWVPLE1BQU1BLElBQU4sU0FBbUJDLGtCQUFuQixDQUE2QjtBQUlsQ0MsRUFBQUEsV0FBVyxDQUFDQyxRQUFELEVBQW1C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QU9zQixRQUFRLENBQUNVLGtCQUFULENBQTRCakMsR0FBRyxDQUFDMEIsTUFBaEMsRUFBd0NFLE1BQU0sQ0FBQ1QsSUFBL0MsQ0FBUDtBQUNEOztBQUVrQyxRQUF0QmUsc0JBQXNCLENBQ2pDbEMsR0FEaUMsRUFFaEI7QUFDakIsVUFBTUwsTUFBTSxHQUFHLE1BQU0sS0FBS0QsYUFBTCxDQUFtQk0sR0FBRyxDQUFDQyxJQUF2QixDQUFyQjtBQUVBLFdBQU8sSUFBSWtDLG9DQUFKLENBQ0wsSUFESyxFQUVMeEMsTUFGSyxFQUdMO0FBQ0VTLE1BQUFBLFFBQVEsRUFBRUosR0FBRyxDQUFDSSxRQURoQjtBQUVFQyxNQUFBQSxRQUFRLEVBQUVMLEdBQUcsQ0FBQ0ssUUFGaEI7QUFHRUMsTUFBQUEsTUFBTSxFQUFFTixHQUFHLENBQUNNLE1BSGQ7QUFJRWEsTUFBQUEsSUFBSSxFQUFFbkIsR0FBRyxDQUFDbUI7QUFKWixLQUhLLEVBU0w7QUFBRW5DLE1BQUFBLE1BQU0sRUFBRSxLQUFLQTtBQUFmLEtBVEssRUFVTDBCLE9BVkssRUFBUDtBQVdEOztBQXpKaUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiB0c2xpbnQ6ZGlzYWJsZTpuby1hbnkgKi9cbmltcG9ydCB7IEFjY291bnQsIFJlbW90ZUFjY291bnQgfSBmcm9tIFwiLi9hY2NvdW50L2FjY291bnRcIjtcbmltcG9ydCB7IEFjY291bnRzIH0gZnJvbSBcIi4vYWNjb3VudC9hY2NvdW50c1wiO1xuaW1wb3J0IHtcbiAgQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZE1ldGhvZCxcbiAgU2lnbmVyUGx1Z2luLFxuICBUcmFuc2Zlck1ldGhvZFxufSBmcm9tIFwiLi9hY3Rpb24vbWV0aG9kXCI7XG5pbXBvcnQgeyBDb250cmFjdCB9IGZyb20gXCIuL2NvbnRyYWN0L2NvbnRyYWN0XCI7XG5pbXBvcnQgUnBjTWV0aG9kIGZyb20gXCIuL3JwYy1tZXRob2RcIjtcbmltcG9ydCB7IElScGNNZXRob2QgfSBmcm9tIFwiLi9ycGMtbWV0aG9kL3R5cGVzXCI7XG5pbXBvcnQge1xuICBDbGFpbUZyb21SZXdhcmRpbmdGdW5kUmVxdXNldCxcbiAgQ29udHJhY3RSZXF1ZXN0LFxuICBFeGVjdXRlQ29udHJhY3RSZXF1ZXN0LFxuICBUcmFuc2ZlclJlcXVlc3Rcbn0gZnJvbSBcIi4vdHlwZXNcIjtcblxudHlwZSBJb3R4T3B0cyA9IHtcbiAgc2lnbmVyPzogU2lnbmVyUGx1Z2luO1xuICB0aW1lb3V0PzogbnVtYmVyO1xuICBhcGlUb2tlbj86IHN0cmluZztcbn07XG5cbmV4cG9ydCBjbGFzcyBJb3R4IGV4dGVuZHMgUnBjTWV0aG9kIHtcbiAgcHVibGljIGFjY291bnRzOiBBY2NvdW50cztcbiAgcHVibGljIHNpZ25lcj86IFNpZ25lclBsdWdpbjtcblxuICBjb25zdHJ1Y3Rvcihob3N0bmFtZTogc3RyaW5nLCBvcHRzPzogSW90eE9wdHMpIHtcbiAgICBzdXBlcihob3N0bmFtZSwge1xuICAgICAgdGltZW91dDogb3B0cyAmJiBvcHRzLnRpbWVvdXQsXG4gICAgICBhcGlUb2tlbjogb3B0cyAmJiBvcHRzLmFwaVRva2VuXG4gICAgfSk7XG4gICAgdGhpcy5hY2NvdW50cyA9IG5ldyBBY2NvdW50cygpO1xuICAgIHRoaXMuc2lnbmVyID0gb3B0cyAmJiBvcHRzLnNpZ25lcjtcbiAgICBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHNpZ25lciA9IHRoaXMuc2lnbmVyO1xuICAgICAgaWYgKHNpZ25lciAmJiBzaWduZXIuZ2V0QWNjb3VudHMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCBhY2NvdW50cyA9IGF3YWl0IHNpZ25lci5nZXRBY2NvdW50cygpO1xuICAgICAgICAgIGFjY291bnRzLmZvckVhY2goYWNjb3VudCA9PiB7XG4gICAgICAgICAgICB0aGlzLmFjY291bnRzLmFkZEFjY291bnQoXG4gICAgICAgICAgICAgIG5ldyBSZW1vdGVBY2NvdW50KGFjY291bnQuYWRkcmVzcywgc2lnbmVyKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBmZXRjaCByZW1vdGUgYWNjb3VudHMgYWRkcmVzcyBlcnJvcjogJHtlcnJ9YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LCAyMDAwKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB0cnlHZXRBY2NvdW50KGFkZHJlc3M6IHN0cmluZyk6IFByb21pc2U8QWNjb3VudD4ge1xuICAgIGNvbnN0IHNlbmRlciA9XG4gICAgICB0aGlzLnNpZ25lciAmJiB0aGlzLnNpZ25lci5nZXRBY2NvdW50XG4gICAgICAgID8gYXdhaXQgdGhpcy5zaWduZXIuZ2V0QWNjb3VudChhZGRyZXNzKVxuICAgICAgICA6IHRoaXMuYWNjb3VudHMuZ2V0QWNjb3VudChhZGRyZXNzKTtcbiAgICBpZiAoIXNlbmRlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBjYW5ub3QgZmluZCBhY2NvdW50OiAke2FkZHJlc3N9YCk7XG4gICAgfVxuICAgIHJldHVybiBzZW5kZXI7XG4gIH1cblxuICBwdWJsaWMgY3VycmVudFByb3ZpZGVyKCk6IElScGNNZXRob2Qge1xuICAgIHJldHVybiB0aGlzLmNsaWVudDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZW5kVHJhbnNmZXIocmVxOiBUcmFuc2ZlclJlcXVlc3QpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IHNlbmRlciA9IGF3YWl0IHRoaXMudHJ5R2V0QWNjb3VudChyZXEuZnJvbSk7XG4gICAgY29uc3QgcGF5bG9hZCA9IHJlcS5wYXlsb2FkIHx8IFwiXCI7XG4gICAgcmV0dXJuIG5ldyBUcmFuc2Zlck1ldGhvZChcbiAgICAgIHRoaXMsXG4gICAgICBzZW5kZXIsXG4gICAgICB7XG4gICAgICAgIGdhc0xpbWl0OiByZXEuZ2FzTGltaXQsXG4gICAgICAgIGdhc1ByaWNlOiByZXEuZ2FzUHJpY2UsXG4gICAgICAgIGFtb3VudDogcmVxLnZhbHVlLFxuICAgICAgICByZWNpcGllbnQ6IHJlcS50byxcbiAgICAgICAgcGF5bG9hZDogcGF5bG9hZFxuICAgICAgfSxcbiAgICAgIHsgc2lnbmVyOiB0aGlzLnNpZ25lciB9XG4gICAgKS5leGVjdXRlKCk7XG4gIH1cblxuICAvLyByZXR1cm4gYWN0aW9uIGhhc2hcbiAgcHVibGljIGFzeW5jIGRlcGxveUNvbnRyYWN0KFxuICAgIHJlcTogQ29udHJhY3RSZXF1ZXN0LFxuICAgIC4uLmFyZ3M6IEFycmF5PGFueT5cbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBpZiAodHlwZW9mIHJlcS5hYmkgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJlcS5hYmkgPSBKU09OLnBhcnNlKHJlcS5hYmkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJwYXJzZSBhYmkgdG8gQUJJRGVmaW5pdGlvbiBlcnJvclwiKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBzZW5kZXIgPSBhd2FpdCB0aGlzLnRyeUdldEFjY291bnQocmVxLmZyb20pO1xuXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHJldHVybiBuZXcgQ29udHJhY3QocmVxLmFiaSwgdW5kZWZpbmVkLCB7XG4gICAgICBkYXRhOiByZXEuZGF0YSxcbiAgICAgIHByb3ZpZGVyOiB0aGlzLFxuICAgICAgc2lnbmVyOiB0aGlzLnNpZ25lclxuICAgIH0pLmRlcGxveShzZW5kZXIsIGFyZ3MsIHJlcS5hbW91bnQsIHJlcS5nYXNMaW1pdCwgcmVxLmdhc1ByaWNlKTtcbiAgfVxuXG4gIC8vIHJldHVybiBhY3Rpb24gaGFzaFxuICBwdWJsaWMgYXN5bmMgZXhlY3V0ZUNvbnRyYWN0KFxuICAgIHJlcTogRXhlY3V0ZUNvbnRyYWN0UmVxdWVzdCxcbiAgICAuLi5hcmdzOiBBcnJheTxhbnk+XG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgaWYgKHR5cGVvZiByZXEuYWJpID09PSBcInN0cmluZ1wiKSB7XG4gICAgICB0cnkge1xuICAgICAgICByZXEuYWJpID0gSlNPTi5wYXJzZShyZXEuYWJpKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwicGFyc2UgYWJpIHRvIEFCSURlZmluaXRpb24gZXJyb3JcIik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3Qgc2VuZGVyID0gYXdhaXQgdGhpcy50cnlHZXRBY2NvdW50KHJlcS5mcm9tKTtcblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCBjb250cmFjdCA9IG5ldyBDb250cmFjdChyZXEuYWJpLCByZXEuY29udHJhY3RBZGRyZXNzLCB7XG4gICAgICBwcm92aWRlcjogdGhpcyxcbiAgICAgIHNpZ25lcjogdGhpcy5zaWduZXJcbiAgICB9KTtcbiAgICByZXR1cm4gY29udHJhY3QubWV0aG9kc1tyZXEubWV0aG9kXSguLi5hcmdzLCB7XG4gICAgICBhY2NvdW50OiBzZW5kZXIsXG4gICAgICBhbW91bnQ6IHJlcS5hbW91bnQsXG4gICAgICBnYXNMaW1pdDogcmVxLmdhc0xpbWl0LFxuICAgICAgZ2FzUHJpY2U6IHJlcS5nYXNQcmljZVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlYWRDb250cmFjdEJ5TWV0aG9kKFxuICAgIHJlcTogRXhlY3V0ZUNvbnRyYWN0UmVxdWVzdCxcbiAgICAuLi5hcmdzOiBBcnJheTxhbnk+XG4gICk6IFByb21pc2U8YW55IHwgQXJyYXk8YW55Pj4ge1xuICAgIGlmICh0eXBlb2YgcmVxLmFiaSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmVxLmFiaSA9IEpTT04ucGFyc2UocmVxLmFiaSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcInBhcnNlIGFiaSB0byBBQklEZWZpbml0aW9uIGVycm9yXCIpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCBjb250cmFjdCA9IG5ldyBDb250cmFjdChyZXEuYWJpLCByZXEuY29udHJhY3RBZGRyZXNzLCB7XG4gICAgICBwcm92aWRlcjogdGhpcyxcbiAgICAgIHNpZ25lcjogdGhpcy5zaWduZXJcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVhZENvbnRyYWN0KHtcbiAgICAgIGV4ZWN1dGlvbjogY29udHJhY3QucHVyZUVuY29kZU1ldGhvZChcIjBcIiwgcmVxLm1ldGhvZCwgLi4uYXJncyksXG4gICAgICBjYWxsZXJBZGRyZXNzOiByZXEuZnJvbVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGNvbnRyYWN0LmRlY29kZU1ldGhvZFJlc3VsdChyZXEubWV0aG9kLCByZXN1bHQuZGF0YSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY2xhaW1Gcm9tUmV3YXJkaW5nRnVuZChcbiAgICByZXE6IENsYWltRnJvbVJld2FyZGluZ0Z1bmRSZXF1c2V0XG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3Qgc2VuZGVyID0gYXdhaXQgdGhpcy50cnlHZXRBY2NvdW50KHJlcS5mcm9tKTtcblxuICAgIHJldHVybiBuZXcgQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZE1ldGhvZChcbiAgICAgIHRoaXMsXG4gICAgICBzZW5kZXIsXG4gICAgICB7XG4gICAgICAgIGdhc0xpbWl0OiByZXEuZ2FzTGltaXQsXG4gICAgICAgIGdhc1ByaWNlOiByZXEuZ2FzUHJpY2UsXG4gICAgICAgIGFtb3VudDogcmVxLmFtb3VudCxcbiAgICAgICAgZGF0YTogcmVxLmRhdGFcbiAgICAgIH0sXG4gICAgICB7IHNpZ25lcjogdGhpcy5zaWduZXIgfVxuICAgICkuZXhlY3V0ZSgpO1xuICB9XG59XG4iXX0=